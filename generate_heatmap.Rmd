---
title: Analyse proteasomal gene expression in Tex and T_EM
author: "M. Andreatta <massimo.andreatta at unil.ch> and S. Carmona <santiago.carmona at unil.ch>"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
#output: html_notebook
---

```{r}
library(ggplot2)
library(Seurat)
library(UCell)
library(scGate)
library(EnhancedVolcano)
library(Scillus)
library(msigdbr)
library(presto)
library(tibble)
library(fgsea)
```


Load list of annotated datasets
(from Zheng et al. Science collection, prepared using classify_cancer_samples.Rmd script)

```{r message=F, warning=F}
ddir <- "./aux"
data.list <- readRDS(sprintf("%s/Zheng.seurat.gated.annotated.Tex_Tem.rds", ddir))

data.use <- lapply(data.list, function(x) {
  c <- x@assays$RNA@data
  sums <- apply(c, 1, function(r){sum(r>0)})
  
  genes.keep <- names(sums[sums>=1])
  x@assays$RNA@data <- x@assays$RNA@data[genes.keep,]
  x@assays$RNA@counts <- x@assays$RNA@counts[genes.keep,]
  x@assays$RNA@meta.features <- x@assays$RNA@meta.features[genes.keep, , drop=FALSE]
  x@reductions <- list()
  x
})

#Only keep studies with a minimum number of cells
min.cells <- 500
ncells <- unlist(lapply(data.use, ncol))
data.use <- data.use[ncells > min.cells]

#Downsample overrepresented sets
data.use <- lapply(data.use, function(x) {
  Idents(x) <- "functional.cluster"
  subset(x, cells=WhichCells(x,downsample=3000))
})

#Merge data
merged <- Reduce(f=merge, x=data.use)

saveRDS(merged, file="aux/Zheng.seurat.gated.annotated.Tex_Tem.merged.rds")
merged <- readRDS("aux/Zheng.seurat.gated.annotated.Tex_Tem.merged.rds")

table(merged$dataset, merged$functional.cluster)
```
Calculate dimensionality reductions
```{r}
set.seed(12345)
ndim=10

nvar=300
ntot=300
blist <- unlist(scGate::genes.blacklist.default$Hs)

#Find variable features individually in each dataset, then combine
varfeat <- lapply(data.use, function(x) {
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = nvar, verbose = FALSE)
    x@assays$RNA@var.features
})

s <- names(sort(table(unlist(varfeat)), decreasing = T))
s <- s[!s %in% blist]

var.use <- head(s, ntot)
merged@assays$RNA@var.features <- var.use

merged <- ScaleData(merged, do.scale = TRUE, do.center = TRUE) 
merged <- RunPCA(object = merged, features = var.use, ndims.print = 1:5, nfeatures.print = 10, npcs = ndim)
merged <- RunUMAP(merged, reduction = "pca", dims = 1:ndim, seed.use=123)

```

Have a look of the data
```{r fig.height=3}
palette <- c("#53B400","#edbe2a")
DimPlot(merged, group.by = "dataset") + theme(aspect.ratio=1) + ggtitle("By study")
DimPlot(merged, group.by = "functional.cluster", cols=palette) + theme(aspect.ratio=1) + ggtitle("ProjecTILs annotation")

FeaturePlot(merged, features=c("CD2","CD8A","CD8B","CD4","CD3G","CD3E"), ncol=3)
FeaturePlot(merged, features=c("CD3D","LCK","SPI1","MS4A1","KLRB1","NCAM1"), ncol=3)
FeaturePlot(merged, features=c("CXCL13","FOS","CCL3","CCL5","GZMB","GZMK"), ncol=3)
FeaturePlot(merged, features=c("HAVCR2","TOX","PDCD1","IL7R","CCR7","LAG3"), ncol=3)
```


Expression of typical Tex/Tem markers
```{r fig.height=1.5, fig.width=5}
Idents(merged) <- "functional.cluster"
VlnPlot(merged, features=c("HAVCR2","PDCD1","LAG3","TOX","GZMB","GZMK","IL7R","CCR7","MKI67","TOP2A","CXCL13"), 
        pt.size = 0, stack = T, flip = F, cols=palette, fill.by = "ident")
```


Find DEGs
```{r}
markers <- FindMarkers(merged, group.by = "functional.cluster",  
                       min.diff.pct = 0.2,
                    #   min.pct = 0.5,
                       ident.1 = "CD8_Tex", ident.2 = "CD8_EffectorMemory")

markers <- subset(markers, subset = p_val <= 0.05)
head(markers)
dim(markers)

markers <- subset(markers, subset = abs(avg_log2FC) >= 0.5)

#EnhancedVolcano(markers, x = "avg_log2FC", y = "p_val_adj", lab = rownames(markers))

markers.list <- rownames(markers)
```

Proteasomal genes
```{r}
#proteasomal.genes <- c("PSMA1","PSMA2", "PSMA3","PSMA4","PSMA5","PSMA6","PSMA7",
#                  "PSMA8","PSMB1","PSMB2","PSMB3","PSMB4","PSMB5","PSMB6","PSMB7",
#                  "PSMB8","PSMB9","PSMB10","PSMC1","PSMC2","PSMC3","PSMC4","PSMC5",
#                  "PSMC6","PSMD1","PSMD2","PSMD3","PSMD4","PSMD5","PSMD6","PSMD7",
#                  "PSMD8","PSMD9","PSMD10","PSMD11","PSMD12","PSMD13","PSMD14",
#                  "Sem1","Adrm1","PSME1","PSME2","PSME3","PSME4","PSMF1")


proteasomal.genes <- c("PSMA1", "PSMA2", "PSMA3", "PSMA4", "PSMA5", "PSMA6", "PSMA7",
                       "PSMB1", "PSMB2", "PSMB3", "PSMB4", "PSMB5", "PSMB6", "PSMB7",
                       "PSMC1", "PSMC2", "PSMC3", "PSMC4", "PSMC5", "PSMC6",
                       "PSMD1", "PSMD2", "PSMD3", "PSMD4", "PSMD6", "PSMD7", 
                       "PSMD8", "PSMD11", "PSMD12", "PSMD13", "PSMD14")

```


```{r fig.height=1.5, fig.width=8}
Idents(merged) <- "functional.cluster"
VlnPlot(merged, features=proteasomal.genes, 
        pt.size = 0, stack = T, flip = F, cols=palette, fill.by = "ident")
```

#Generate heatmap

```{r}
library(RColorBrewer)

#Using all datasets is messy. Make a selection
dsets.use <- c("BCC.KathrynEYost2019","BCL.zhangLab5P","BC.Elham2018.10X","BC.zhangLab5P",
               "UCEC.zhangLab5P","RC.zhangLab5P","MM.zhangLab5P")

pheatmap <- subset(merged, subset=dataset %in% dsets.use)
DefaultAssay(pheatmap) <- "RNA"

pheatmap <- pheatmap[proteasomal.genes,]
pheatmap_Tex <- subset(pheatmap, subset = functional.cluster == "CD8_Tex")
pheatmap_Tem <- subset(pheatmap, subset = functional.cluster == "CD8_EffectorMemory")
#Subset
set.seed(1234)
pheatmap_Tem <- pheatmap_Tem[, sample(colnames(pheatmap_Tem), size = ncol(pheatmap_Tex), replace=F)]
pheatmap <- merge(pheatmap_Tem, pheatmap_Tex)



#pheatmap <- NormalizeData(pheatmap, normalization.method = "LogNormalize", scale.factor = 10000)
pheatmap <- ScaleData(pheatmap, features = proteasomal.genes)

#Colors
n_colors <- length(unique(merged$cancerType))
palette_info <- brewer.pal.info[brewer.pal.info$category == "qual", ]
palette_all <- unlist(mapply(brewer.pal,                 
                              palette_info$maxcolors,
                              rownames(palette_info)))

anno_colors <- list(palette,
              sample(palette_all, n_colors)) 

#tiff('Heatmap.tiff', res=700, width = 5000, height = 4000, units='px', compression = 'lzw')
plot_heatmap(dataset = pheatmap,
             row_font_size = 8,
             markers = proteasomal.genes,
             sort_var = c("functional.cluster","cancerType"),
             anno_var = c("functional.cluster","cancerType"),
             anno_colors = anno_colors,
             hm_limit = c(-2,0,2),
             hm_colors = c("red", "white","mediumblue"))
```


######################################################################################
######### GSEA using all genes from the T cells extracted from the 4 studies #########
######################################################################################

# Use all genes from the CD8A expressing T cells from the 4 studies included (withouth lung_1).

```{r}
markers.genes <- wilcoxauc(X = merged, 'functional.cluster')
dplyr::count(markers.genes, group)

markers.genes <- markers.genes %>%
  dplyr::filter(pval <= 0.05) %>%
  dplyr::filter(group == "CD8_Tex") %>%
  arrange(desc(logFC)) %>%
  dplyr::select(feature, logFC)           # select only the features with p< 0.05 and order by logFC.

ranks<- deframe(markers.genes)
head(ranks)

barplot(sort(ranks, decreasing = T))
```
# Load the reference

# To do Gene set enrichment analysis, we need to have the annotated gene set first. One popular source is the MsigDB from Broad Institute.
# https://www.gsea-msigdb.org/gsea/msigdb/index.jsp

```{r}
m_df<- msigdbr(species = "Homo sapiens", category = "H")
head(m_df)

fgsea_sets <- m_df %>% split(x = .$gene_symbol, f = .$gs_name)

# Run the analysis

fgseaRes<- fgsea(fgsea_sets, ranks, minSize=15, maxSize = 500, nperm= 1000)

head(fgseaRes[order(padj, -abs(NES)), ], n=10)

#write.xlsx(fgseaRes[,c(1:7)], "GSEA_pathways.xlsx", sheetName = "H_4studies", append = TRUE)

# Plot the results

pathway <- "HALLMARK_REACTIVE_OXYGEN_SPECIES_PATHWAY"

#tiff('HALLMARK_REACTIVE_OXYGEN_SPECIES_PATHWAY.tiff', res=700, width = 3000, height = 1300, units='px', compression = 'lzw')
plotEnrichment(fgsea_sets[[pathway]], ranks, ticksSize = 0.5, stats = T) +
  labs(title=pathway) +
  plotGseaTable(fgsea_sets[[pathway]], ranks, fgseaRes, gseaParam = 1) + 
  theme_bw()

#dev.off()


#tiff('Panel GSEA.tiff', res=700, width = 3000, height = 1300, units='px', compression = 'lzw')

dev.off()
```

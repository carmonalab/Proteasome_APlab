---
title: Analyse proteasomal gene expression in Tex and T_EM
author: "M. Andreatta <massimo.andreatta at unil.ch> and S. Carmona <santiago.carmona at unil.ch>"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
#output: html_notebook
---

```{r warning=F, message=F, results=F}
library(ggplot2)
library(Seurat)
library(UCell)
library(scGate)
library(EnhancedVolcano)
library(msigdbr)
library(presto)
library(tibble)
library(fgsea)
```


Load list of annotated datasets
(from Zheng et al. Science collection, prepared using classify_cancer_samples.Rmd script)

```{r message=F, warning=F}
ddir <- "./aux"
set.seed(123)
only.tumor <- TRUE

data.list <- readRDS(sprintf("%s/Zheng.seurat.gated.annotated.Tex_Tem.rds", ddir))
#File available at: https://www.dropbox.com/s/7g8q4hhdtccme95/Zheng.seurat.gated.annotated.Tex_Tem.rds?dl=0

data.use <- lapply(data.list, function(x) {
  c <- x@assays$RNA@data
  sums <- apply(c, 1, function(r){sum(r>0)})
  
  genes.keep <- names(sums[sums>=1])
  x@assays$RNA@data <- x@assays$RNA@data[genes.keep,]
  x@assays$RNA@counts <- x@assays$RNA@counts[genes.keep,]
  x@assays$RNA@meta.features <- x@assays$RNA@meta.features[genes.keep, , drop=FALSE]
  x@reductions <- list()
  
  #Only consider cells from primary tumor?
  if (only.tumor) {
    if ("T" %in% x$loc) {
       x <- subset(x, subset=loc=="T")
    } else {
       x <- NULL
    }
  }
  x
  
})
data.use[sapply(data.use, is.null)] <- NULL


#Downsample overrepresented sets (max 500 Tex / Tem per sample)
data.use <- lapply(data.use, function(x) {
  
  x.l <- SplitObject(x, split.by="patient")
  x.l <- lapply(x.l, function(s) {
     Idents(s) <- "functional.cluster"
     subset(s, cells=WhichCells(s,downsample=500))
  })
  
  #Only keep samples with a minimum number of cells
  min.cells <- 30
  ncells <- unlist(lapply(x.l, function(x){min(table(x$functional.cluster))}))
  x.l <- x.l[ncells > min.cells]
  
  Reduce(f=merge, x=x.l)
})

#Remove NULL elements
data.use[sapply(data.use, is.null)] <- NULL

#Also exclude study by Sade-Feldman et al. - some samples come from LN but all are marked as tumor here
data.use <- data.use[names(data.use) != "MELA.MosheSade-Feldman2018"]
```

Calculate variable features per study
```{r}
set.seed(12345)
ndim=10

nvar=300
ntot=300
blist <- unlist(scGate::genes.blacklist.default$Hs)

#Find variable features individually in each dataset, then combine
varfeat <- lapply(data.use, function(x) {
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = nvar, verbose = FALSE)
    x@assays$RNA@var.features
})

s <- names(sort(table(unlist(varfeat)), decreasing = T))
s <- s[!s %in% blist]

var.use <- head(s, ntot)
```

Merge data
```{r}
merged <- Reduce(f=merge, x=data.use)

table(merged$dataset, merged$functional.cluster)

merged@assays$RNA@var.features <- var.use

```

Label (and split?) by technology
```{r}
merged$tech.type <- "UMI"
merged$tech.type[merged$dataset %in% c("CRC.zhangLabSS2","HCC.zhangLabSS2","LUNG.zhangLabSS2",
                                  "Melanoma.LivnatJerby-Arnon2018","Melanoma.MosheSade-Feldman2018")] <- "TPM"
```

Dimensionality reductions
```{r}
ndim=10
merged <- ScaleData(merged, do.scale = TRUE, do.center = TRUE) 
merged <- RunPCA(object = merged, features = var.use, ndims.print = 1:5, nfeatures.print = 10, npcs = ndim)
merged <- RunUMAP(merged, reduction = "pca", dims = 1:ndim, seed.use=123)

saveRDS(merged, file="aux/Zheng.seurat.gated.annotated.Tex_Tem.merged.rds")
```

```{r, eval=F}
#Merged data available at: https://www.dropbox.com/s/igg3nrfmte7b5z8/Zheng.seurat.gated.annotated.Tex_Tem.merged.rds?dl=0
merged <- readRDS("aux/Zheng.seurat.gated.annotated.Tex_Tem.merged.rds")
```


Have a look of the data
```{r fig.height=3}
palette <- c("#53B400","#edbe2a")
DimPlot(merged, group.by = "dataset") + theme(aspect.ratio=1) + ggtitle("By study")
DimPlot(merged, group.by = "functional.cluster", cols=palette) + theme(aspect.ratio=1) + ggtitle("ProjecTILs annotation")
DimPlot(merged, group.by = "tech.type") + theme(aspect.ratio=1) + ggtitle("Technology")


FeaturePlot(merged, features=c("CD2","CD8A","CD8B","CD4","CD3G","CD3E"), ncol=3)
FeaturePlot(merged, features=c("CD3D","LCK","SPI1","MS4A1","KLRB1","NCAM1"), ncol=3)
FeaturePlot(merged, features=c("CXCL13","FOS","CCL3","CCL5","GZMB","GZMK"), ncol=3)
FeaturePlot(merged, features=c("HAVCR2","TOX","PDCD1","IL7R","CCR7","LAG3"), ncol=3)
```
Expression of typical Tex/Tem markers
```{r fig.height=1.5, fig.width=5}
Idents(merged) <- "functional.cluster"
VlnPlot(merged, features=c("HAVCR2","PDCD1","LAG3","TOX","MKI67","CXCL13","GZMB","GZMK","GZMM","ANXA1","IL7R","TCF7"), 
        pt.size = 0, stack = T, flip = F, cols=palette, fill.by = "ident")

ggsave("plots/violin.Tex.vs.EM.markers.pdf", height=3, width=10)
```

Internal control
Zheng's annotation
```{r}
merged$meta.cluster.coarse.TexTem <- NA
merged$meta.cluster.coarse.TexTem[merged$meta.cluster.coarse %in% c("CD8.c09.Tex.CXCL13","CD8.c05.Tem.GZMK")] <- merged$meta.cluster.coarse[merged$meta.cluster.coarse %in% c("CD8.c09.Tex.CXCL13","CD8.c05.Tem.GZMK")]
```

Split by technology
```{r}
merged.tech <- SplitObject(merged, split.by = "tech.type")

#exclude Li et al. dataset 
merged.tech$UMI <- subset(merged.tech$UMI, subset=dataset=="Melanoma.HanjieLi2018", invert=T)  
```


```{r fig.height=3, fig.width=5}
a <- VlnPlot(merged.tech$UMI, features=c("HAVCR2","PDCD1","LAG3","TOX","MKI67","CXCL13","GZMB","GZMK","GZMM","ANXA1","IL7R","TCF7"), 
        pt.size = 0, stack = T, flip = F, cols=palette, fill.by = "ident")

b <- VlnPlot(merged.tech$TPM, features=c("HAVCR2","PDCD1","LAG3","TOX","MKI67","CXCL13","GZMB","GZMK","GZMM","ANXA1","IL7R","TCF7"), 
        pt.size = 0, stack = T, flip = F, cols=palette, fill.by = "ident")

a / b
```

```{r}
VlnPlot(merged, features=c("nFeature_RNA","nCount_RNA"), pt.size=0, cols = palette)
```


Internal control Zheng's annotation

```{r fig.height=3, fig.width=5}
Idents(merged.tech$UMI) <- "meta.cluster.coarse.TexTem"

a <- VlnPlot(merged.tech$UMI, features=c("HAVCR2","PDCD1","LAG3","TOX","MKI67","CXCL13","GZMB","GZMK","GZMM","ANXA1","IL7R","TCF7"), 
        pt.size = 0, stack = T, flip = F, cols=rev(palette), fill.by = "ident")

Idents(merged.tech$UMI) <- "functional.cluster"

Idents(merged.tech$TPM) <- "meta.cluster.coarse.TexTem"

b <- VlnPlot(merged.tech$TPM, features=c("HAVCR2","PDCD1","LAG3","TOX","MKI67","CXCL13","GZMB","GZMK","GZMM","ANXA1","IL7R","TCF7"), 
        pt.size = 0, stack = T, flip = F, cols=rev(palette), fill.by = "ident")

Idents(merged.tech$TPM) <- "functional.cluster"

a / b

```
Technology biases are very similar for both ProjecTILs and Zheng's annotations



Endika's Proteasomal gene set
```{r}

proteasomal.genes <- c("PSMA1", "PSMA2", "PSMA3", "PSMA4", "PSMA5", "PSMA6", "PSMA7",
                       "PSMB1", "PSMB2", "PSMB3", "PSMB4", "PSMB5", "PSMB6", "PSMB7",
                       "PSMC1", "PSMC2", "PSMC3", "PSMC4", "PSMC5", "PSMC6",
                       "PSMD1", "PSMD2", "PSMD3", "PSMD4", "PSMD6", "PSMD7", 
                       "PSMD8", "PSMD11", "PSMD12", "PSMD13", "PSMD14")

```


```{r fig.height=1.5, fig.width=8}
Idents(merged) <- "functional.cluster"
VlnPlot(merged, features=proteasomal.genes, 
        pt.size = 0, stack = T, flip = F, cols=palette, fill.by = "ident")

ggsave("plots/violin.Tex.vs.EM.protease.pdf", height=3, width=18)
```

```{r fig.height=2.5, fig.width=8}
a <- VlnPlot(merged.tech$UMI, features=proteasomal.genes, 
        pt.size = 0, stack = T, flip = F, cols=palette, fill.by = "ident")

b <- VlnPlot(merged.tech$TPM, features=proteasomal.genes, 
        pt.size = 0, stack = T, flip = F, cols=palette, fill.by = "ident")

a / b
```

#Generate heatmap

Calculate average expression per sample (patient)
Make heatmap
```{r}
make.heatmap <- function(data, assay="RNA", genes, method=c("ward.D", "average"), brewer.palette="PRGn") {
  
  library(pheatmap)
  set.seed(123)
  #Calculate mean expression by subset
  m <- c()
  for( g in unique(genes)){
    m[[g]] <- tapply(data@assays[[assay]][g,],data$subset_dataset_patient, mean)
  }
  m <- as.data.frame(m)

  m.study <- factor(unlist(lapply(strsplit(rownames(m),"@",perl = T),function(x) x[[2]])))
  m.subset <- factor(unlist(lapply(strsplit(rownames(m),"@",perl = T),function(x) x[[1]])))

  breaksList = seq(-2, 2, by = 0.1)
  color = colorRampPalette(rev(brewer.pal(n = 7, name = brewer.palette)))(length(breaksList))

  gaps_col <- (which(!duplicated(m.subset))-1)[-1]

  annotation_col = data.frame(
                    Study = m.study, 
                    TIL_Subtype = m.subset
                )
  rownames(annotation_col) = rownames(m)

  palette <- c("#53B400","#edbe2a")
  names(palette) <- levels(m.subset)

  h <- pheatmap::pheatmap(t(m),cluster_rows = F,
                          cluster_cols = F,scale = "row",
                          breaks = breaksList, color=color, 
                          annotation_col = annotation_col, 
                          gaps_col=gaps_col,show_colnames = F,
                          annotation_colors = list(TIL_Subtype=palette), 
                          fontsize_row=6,fontsize = 7, 
                          clustering_method=method)
  
  return(h)
}
```


Note that data distributions are very different between technologies: "UMI", 5'/3' counting technologies (inDrop, 10x) vs. "TPM" non-UMI full-length RNA technologies (e.g. SS2)). Perform the metanalyses separately for the two technologies
```{r}
library(RColorBrewer)

#Make metanalysis on UMI-type technologies
data.heat <- merged.tech$UMI

DefaultAssay(data.heat) <- "RNA"

data.heat$dataset_patient <- paste0(data.heat$dataset, "@", data.heat$patient)
data.heat$subset_dataset_patient <- paste0(data.heat$functional.cluster, "@", data.heat$dataset_patient)

library(pheatmap)
h <- make.heatmap(data.heat, genes=proteasomal.genes, brewer.palette = "PiYG")
ggsave("plots/heatmap.avg.expression.proteasomal.genes.UMI.pdf", plot=h, height=4, width=10)

markers <- c("HAVCR2","PDCD1","LAG3","TOX","TOX2","ENTPD1","CTLA4","CXCL13","GZMB","IL7R","TCF7","GZMK","GZMM","ANXA1","CCL5")
h <- make.heatmap(data.heat, genes=markers, brewer.palette = "PiYG")
ggsave("plots/heatmap.avg.expression.marker.genes.UMI.pdf", plot=h, height=3, width=10)

```
Can we do the same on SS2 samples?
```{r}
data.heat <- merged.tech$TPM

DefaultAssay(data.heat) <- "RNA"
data.heat$dataset_patient <- paste0(data.heat$dataset, "@", data.heat$patient)
data.heat$subset_dataset_patient <- paste0(data.heat$functional.cluster, "@", data.heat$dataset_patient)

h <- make.heatmap(data.heat, genes=proteasomal.genes, brewer.palette = "PiYG")
ggsave("plots/heatmap.avg.expression.proteasomal.genes.TPM.pdf", plot=h, height=4, width=7)

markers <- c("HAVCR2","PDCD1","LAG3","TOX","TOX2","ENTPD1","CTLA4","CXCL13","GZMB","IL7R","TCF7","GZMK","GZMM","ANXA1","CCL5")
h <- make.heatmap(data.heat, genes=markers, brewer.palette = "PiYG")
ggsave("plots/heatmap.avg.expression.marker.genes.TPM.pdf", plot=h, height=3, width=7)
```

Re-do heatmap splitting by Zheng's annotation meta.cluster.coarse.TexTem

```{r}
library(RColorBrewer)

#Make metanalysis on UMI-type technologies
data.heat <- merged.tech$UMI

DefaultAssay(data.heat) <- "RNA"

data.heat$dataset_patient <- paste0(data.heat$dataset, "@", data.heat$patient)

table(data.heat$meta.cluster.coarse.TexTem,useNA = "always")
data.heat <- subset(data.heat, meta.cluster.coarse.TexTem %in% c("CD8.c05.Tem.GZMK","CD8.c09.Tex.CXCL13"))

data.heat$subset_dataset_patient <- paste0(data.heat$meta.cluster.coarse.TexTem, "@", data.heat$dataset_patient)

library(pheatmap)
h <- make.heatmap(data.heat, genes=proteasomal.genes, brewer.palette = "PiYG")
ggsave("plots/heatmap.avg.expression.proteasomal.genes.UMI.Zheng.pdf", plot=h, height=4, width=10)

markers <- c("HAVCR2","PDCD1","LAG3","TOX","TOX2","ENTPD1","CTLA4","CXCL13","GZMB","IL7R","TCF7","GZMK","GZMM","ANXA1","CCL5")
h <- make.heatmap(data.heat, genes=markers, brewer.palette = "PiYG")
ggsave("plots/heatmap.avg.expression.marker.genes.UMI.Zheng.pdf", plot=h, height=3, width=10)

```


#######################################
######### GSEA using all DEG  #########
#######################################

Find DEGs
```{r}
markers <- FindMarkers(merged.tech$UMI, group.by = "functional.cluster",  
                       min.diff.pct = 0.1,
                       ident.1 = "CD8_Tex", ident.2 = "CD8_EffectorMemory")

markers <- subset(markers, subset = p_val <= 0.05)
head(markers)
dim(markers)


markers <- subset(markers, subset = abs(avg_log2FC) >= 0.5)

#EnhancedVolcano(markers, x = "avg_log2FC", y = "p_val_adj", lab = rownames(markers))

markers.list <- rownames(markers)
```

# Performs GSEA using genes overexpressed in Tex compared to Tem

```{r}
markers.genes <- wilcoxauc(X = merged, 'functional.cluster')
dplyr::count(markers.genes, group)

markers.genes <- markers.genes %>%
  dplyr::filter(pval <= 0.05) %>%
  dplyr::filter(group == "CD8_Tex") %>%
  arrange(desc(logFC)) %>%
  dplyr::select(feature, logFC)           # select only the features with p< 0.05 and order by logFC.

ranks<- deframe(markers.genes)
head(ranks)

barplot(sort(ranks, decreasing = T))
```
# Load the reference

# To do Gene set enrichment analysis, we need to have the annotated gene set first. One popular source is the MsigDB from Broad Institute.
# https://www.gsea-msigdb.org/gsea/msigdb/index.jsp

```{r}
m_df<- msigdbr(species = "Homo sapiens", category = "H")
head(m_df)

fgsea_sets <- m_df %>% split(x = .$gene_symbol, f = .$gs_name)

# Run the analysis

fgseaRes<- fgsea(fgsea_sets, ranks, minSize=15, maxSize = 500, nperm= 1000)

head(fgseaRes[order(padj, -abs(NES)), ], n=10)

#write.xlsx(fgseaRes[,c(1:7)], "GSEA_pathways.xlsx", sheetName = "H_4studies", append = TRUE)

# Plot the results

pathway <- "HALLMARK_REACTIVE_OXYGEN_SPECIES_PATHWAY"

#tiff('HALLMARK_REACTIVE_OXYGEN_SPECIES_PATHWAY.tiff', res=700, width = 3000, height = 1300, units='px', compression = 'lzw')
plotEnrichment(fgsea_sets[[pathway]], ranks, ticksSize = 0.5, stats = T) +
  labs(title=pathway) +
  plotGseaTable(fgsea_sets[[pathway]], ranks, fgseaRes, gseaParam = 1) + 
  theme_bw()

#dev.off()


#tiff('Panel GSEA.tiff', res=700, width = 3000, height = 1300, units='px', compression = 'lzw')

#dev.off()
```

---
title: Classify T cells from multiple studies (human cancers)
author: "M. Andreatta <massimo.andreatta at unil.ch> and S. Carmona <santiago.carmona at unil.ch>"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
#output: html_notebook
---

```{r warning=F, message=F, results=F}
library(renv)
renv::restore()

library(ggplot2)
library(Seurat)
library(UCell)
library(scGate)
#remotes::install_github("carmonalab/ProjecTILs", ref="518bd89")  #specify commit, for reproducibility

library(ProjecTILs)
library(SingleCellExperiment)
library(viridis)
```


We will use the collection of single-cell data by Zheng et al. (2021) Science, which covers 21 cancer types and 300 patients.

paper: https://www.science.org/doi/10.1126/science.abe6474
Data: https://zenodo.org/record/5461803#.YgT60GAo-eQ

```{r}
datapath <- "~/Dropbox/CSI/Datasets/Zhang_TIL_Science2021/expression/CD8/byDataset"

data.list <- list()
for (file in list.files(datapath)) {
  name <- gsub(pattern='.sce.rds', replacement = '', x=file)
  data.list[[name]] <- readRDS(sprintf("%s/%s",datapath,file))
}
names(data.list)
```

Convert to Seurat objects
```{r warning=F}
#For initial small tests
#data.list <- data.list[1:3]

seurat.list <- lapply(X = seq_along(data.list),  
                    FUN=function(i) {
                        mainExpName(data.list[[i]]) <- 'RNA'
                        study.name <- names(data.list)[i]
                        study.id <- sprintf("S%02d",i)
                        
                        a <- names(assays(data.list[[i]]))
                        if ("counts" %in% a) {
                           counts.slot = "counts"
                        } else if ("log2TPM" %in% a) {
                           counts.slot = "log2TPM"
                        } else if ("norm_exprs" %in% a) {
                           counts.slot = "norm_exprs" 
                        }  
                        
                        #Use gene names for all objects (stored in display.name)
                        rownames(data.list[[i]]) <- rowData(data.list[[i]])[["display.name"]]  

                        r <- as.Seurat(data.list[[i]], counts = counts.slot, data = "norm_exprs", project=study.name)
                        r <- RenameCells(r, add.cell.id = study.id)
                        
                        
                        #mean <- mean(r@assays$RNA@data["CD8A",])
                        #if (mean > 5) {
                        #   r@assays$RNA@data <- r@assays$RNA@data/3   #dirty, but the data was not consistently normalized
                        #}

                        r
                    })
names(seurat.list) <- names(data.list)

rm(data.list)  #free up memory
gc()
```

Check distributions of normalized counts
```{r fig.height=5, fig.width=8}
gene <- "CD2"
pll <- lapply(names(seurat.list),
       function(x){
          df <- data.frame(counts = seurat.list[[x]]@assays$RNA@counts[gene,])
          ggplot(df, aes(x=counts)) + geom_histogram(bins=50) + ggtitle(x)
       })
wrap_plots(pll)

pll <- lapply(names(seurat.list),
       function(x){
          df <- data.frame(norm.data = seurat.list[[x]]@assays$RNA@data[gene,])
          ggplot(df, aes(x=norm.data)) + geom_histogram(bins=50) + ggtitle(x)
       })
wrap_plots(pll)
```
#Rescale flagged datasets 
Data seems to be normalized in inconsistent way. Most datasets have expression of e.g. CD8A
of ~3 on average, another subset of ~9 on average. Try to correct by measuring 90% percentile of key genes

```{r  fig.height=8, fig.width=12}
ref.factor <- 3
seurat.list <- lapply(seurat.list,
       function(x){
          df <- data.frame(x@assays$RNA@data[c("CD2","CD3E","CD3G","CD3D","CD8A","CD8B","PTPRC"),])
          q90 <- apply(df, 1, function(i){quantile(i, c(0.9))[1]})
          q90.mean <- mean(q90)
          print(sprintf("%s - %.3f", unique(x$dataset)[1], q90.mean))
          
          factor <- ref.factor / q90.mean
          #Rescale data with correction factor
          x@assays$RNA@data <- factor * x@assays$RNA@data
          x
       })
```

```{r fig.height=5, fig.width=8}
pll <- lapply(names(seurat.list),
       function(x){
          df <- data.frame(norm.data = seurat.list[[x]]@assays$RNA@data["CD8A",])
          ggplot(df, aes(x=norm.data)) + geom_histogram(bins=50) + ggtitle(x)
       })
wrap_plots(pll)
```

```{r}
saveRDS(seurat.list, "aux/Zheng.seurat.list.rds")
seurat.list <- readRDS("aux/Zheng.seurat.list.rds")
```


Check some signatures for major cell types
```{r}
sigs <- list("Immune"=c("PTPRC"),
             "Myeloid"=c("SPI1"),
             "Tcell"=c("CD3D","CD3E","CD3G","CD2"),
             "Cd8T"=c("CD8A","CD8B","CD4-"),
             "Cd4T"=c("CD4","CD40LG"),
             "Treg"=c("CD4","FOXP3"),
             "Stromal"= c("MMP2","COL1A1","COL1A2","COL5A1","LUM","PDGFRA"),
             "Bcell" = c("CD79A","MS4A1","BANK1","PAX5","CD19"),
             "NK" = c("KLRD1","NKG7","NCR1","FCGR3A","CD3D-","CD3E-","CD3G-"),
             "MoMacDC" = c("LYZ","CSF1R","MSR1","MAFB","CD300E"),
             "Plasma_cell" = c("IGKC","IGHG3","IGHG1","IGHA1","CD19-"),
             "MAIT"=c("KLRB1", "SLC4A10", "NCR3"),
             "iNKT"=c("ZBTB16"),
             "KIR_NK"=c("TXK","KIR2DL3")
             )


cycling.g1 <- scGate::genes.blacklist.default$Hs$cellCycle.G1S
cycling.g2 <- scGate::genes.blacklist.default$Hs$cellCycle.G2M
cycling <- c(cycling.g1, cycling.g2)

sigs$cycling = cycling

seurat.list <- lapply(seurat.list,
       FUN = function(x) {
          AddModuleScore_UCell(x, features = sigs, name=NULL, ncores=4)
       })

```

```{r fig.height=6}

for (type in names(sigs)) {
  
  pll <- lapply(names(seurat.list),
                FUN = function(x) {
                  cols = c("lightgrey", "blue")
                  if (sum(seurat.list[[x]][[type]])==0) {
                     cols = c("lightgrey", "lightgrey")
                  }
                  
                  FeaturePlot(seurat.list[[x]], features=c(type), max.cutoff = 'q99', cols=cols) + 
   #                 scale_color_viridis(option="D", direction=1) + 
                    ggtitle(sprintf("%s (%s)", x, type))
                })
  
  wrap_plots(pll)
  ggsave(sprintf("plots/Zheng.sets.UCell.scores.%s.png", type), height=18, width=25)
}
```
Filter CD8 T cells
```{r warning=F, message=F}
models <- scGate::get_scGateDB()
cd8.model <- models$human$generic$CD8T

#Add MAITs to model
cd8.model <- scGate::gating_model(cd8.model, level=4, negative=T, name="MAIT", signature = c("KLRB1", "SLC4A10", "NCR3"))
cd8.model <- scGate::gating_model(cd8.model, level=4, negative=T, name="iNKT", signature = c("ZBTB16"))

gated.list <- lapply(names(seurat.list),
       FUN = function(x) {
          print(sprintf("#Running dataset %s", x))
          scGate(seurat.list[[x]], model=cd8.model, ncores=4)
       })
names(gated.list) <- names(seurat.list)

rm(seurat.list)  #free up memory
gc()
```

Show results of gating per dataset
```{r fig.height=6}
cols = c("#10f87b","#fa765e")
names(cols) <- c("Pure","Impure")
pll <- lapply(names(gated.list),
       FUN = function(x) {
          DimPlot(gated.list[[x]], group.by="is.pure", cols = cols) + ggtitle(x)
       })

wrap_plots(pll)
ggsave("plots/Zheng.sets.gated.cd8t.png", height=18, width=25)

```

Show 'atlas' annotations
```{r fig.height=6, fig.width=12}
library(RColorBrewer)
cc <- lapply(gated.list, function(x) {
  unique(x$meta.cluster.coarse)
})
clusters <- unique(unlist(cc))

palette <- brewer.pal(n = 12, name = 'Paired')
names(palette) <- clusters
pll <- lapply(names(gated.list),
       FUN = function(x) {
          DimPlot(gated.list[[x]], group.by="meta.cluster.coarse", cols = palette) + ggtitle(x)
       })

wrap_plots(pll)
ggsave("plots/Zheng.sets.by.coarse.cluster.png", height=18, width=35)

```

Plot by sample/patient
```{r fig.height=10, fig.width=20}
pll <- lapply(names(gated.list),
       FUN = function(x) {
          DimPlot(gated.list[[x]], group.by="patient") + ggtitle(x)
       })

wrap_plots(pll)
ggsave("plots/Zheng.sets.by.patient.png", height=18, width=35)
```

Convert to `sce`?
```{r eval=F}
gated.sce <- lapply(gated.list, function(x){
      as.SingleCellExperiment(x)
})
```


Save results of scGate
```{r}
saveRDS(gated.list, "aux/Zheng.seurat.gated.rds")
gated.list <- readRDS("aux/Zheng.seurat.gated.rds")
```


Select pure cells and sufficiently large samples
```{r}
min.cells <- 200
large.samples <- lapply(names(gated.list),
       FUN = function(x) {
          gated.list[[x]] <- subset(gated.list[[x]], subset=is.pure=="Pure")
          gated.list[[x]] <- DietSeurat(gated.list[[x]], dimreducs = NULL, assays = "RNA")
          
          ss <- SplitObject(gated.list[[x]], split.by = 'patient')
          names(ss) <- paste0(x, "_", names(ss))
          
          ncells <- lapply(ss, ncol)
          ss <- ss[ncells>min.cells]
       })
large.samples <- unlist(large.samples, recursive = F)
names(large.samples)
```

Project individual samples in reference TIL atlas
```{r}
library(ProjecTILs)
ref <- load.reference.map()

#Focus on CD8 T cells
is.cd8 <- colnames(ref)[ref$functional.cluster %in% c("CD8_Tex","CD8_Tpex","CD8_EffectorMemory","CD8_EarlyActiv","CD8_NaiveLike")]

ref.cd8 <- subset(ref, cells=is.cd8)
#ref.cd8@misc$pca_object$x <- ref.cd8@misc$pca_object$x[is.cd8,]
#ref.cd8@misc$umap_object$layout <- ref.cd8@misc$umap_object$layout[is.cd8,]
#ref.cd8@misc$umap_object$data <- ref.cd8@misc$umap_object$data[is.cd8,]
plot.projection(ref.cd8)
```

Make projection
```{r}
#ref.use = ref
ref.use = ref.cd8

projected <- make.projection(large.samples, ref=ref.use, filter.cells = FALSE, skip.normalize = T, ncores=8)
#projected <- make.projection(large.samples[1:4], ref=ref.use, filter.cells = FALSE, skip.normalize = T, ncores=4)

projected <- lapply(projected, function(x) {
                      cellstate.predict(ref=ref.use, query=x)
                    })
```

Save results
```{r}
saveRDS(projected, "aux/Zheng.seurat.projected.rds")
projected <- readRDS("aux/Zheng.seurat.projected.rds")
```

```{r fig.height=30, fig.width=40}
pll <- lapply(names(projected),
       FUN = function(x) {
          plot.projection(projected[[x]], ref=ref.use) + NoLegend() + ggtitle(x)
       })

wrap_plots(pll)
ggsave("plots/Zheng.samples.projected.png", height=35, width=50, limitsize = FALSE)
```

```{r fig.height=4, fig.width=10}
genes <- c("Tcf7","Ccr7","Il7r","Cd4","Cd8a","Gzmb","Gzmk","Tox","Pdcd1","Lag3","Havcr2","Cx3cr1","Foxp3")
ProjecTILs::plot.states.radar(ref=ref.use, query=projected[1:4], genes4radar = genes, min.cells = 50)
```


Merge results by study to visualize jointly 
```{r}
studies <- names(gated.list)

matches <- lapply(studies,
       function(s) {
          match <- grep(pattern=s, x=names(projected))
          match
       })
names(matches) <- names(gated.list)

matches <- matches[lapply(matches,length)>0]

projected.by.study <- lapply(names(matches),
                             function(s) {
                               x <- matches[[s]]
                               print(sprintf("%s - merging %i sets",s, length(x)))
                               if (length(x) == 1) {
                                  projected[[x]]
                               } else {
                                  Reduce(f = ProjecTILs:::merge.Seurat.embeddings, x = projected[x])
                               }
                             })
names(projected.by.study) <- names(matches)
length(projected.by.study)                        
names(projected.by.study)

rm(projected)  #free up memory
gc()
```


Show by study
```{r fig.height=15, fig.width=20}

pll <- lapply(names(projected.by.study),
       FUN = function(x) {
          plot.projection(projected.by.study[[x]], ref=ref.use, pointsize = 0.5, linesize = 0.5) + NoLegend() + ggtitle(x)
       })

wrap_plots(pll)
ggsave("plots/Zheng.samples.projected.by.study.png", height=22, width=25)

```

Agreement between studies, and with reference expression profiles
```{r fig.height=4, fig.width=10}
genes <- c("Tcf7","Ccr7","Il7r","Cd4","Cd8a","Gzmb","Gzmk","Tox","Pdcd1","Lag3","Havcr2","Cx3cr1","Cxcl13")

a <- ProjecTILs::plot.states.radar(ref=ref.use, query=projected.by.study[1:6], genes4radar = genes, min.cells = 30, return = T)
ggsave("plots/radars.projected.by.study.1.png", plot = a, height=12, width=25)

a <- ProjecTILs::plot.states.radar(ref=ref.use, query=projected.by.study[7:12], genes4radar = genes, min.cells = 30, return = T)
ggsave("plots/radars.projected.by.study.2.png", plot = a, height=12, width=25)

a <- ProjecTILs::plot.states.radar(ref=ref.use, query=projected.by.study[13:18], genes4radar = genes, min.cells = 30, return = T)
ggsave("plots/radars.projected.by.study.3.png", plot = a, height=12, width=25)

a <- ProjecTILs::plot.states.radar(ref=ref.use, query=projected.by.study[19:24], genes4radar = genes, min.cells = 30, return = T)
ggsave("plots/radars.projected.by.study.4.png", plot = a, height=12, width=25)

a <- ProjecTILs::plot.states.radar(ref=ref.use, query=projected.by.study[25:31], genes4radar = genes, min.cells = 30, return = T)
ggsave("plots/radars.projected.by.study.5.png", plot = a, height=12, width=25)

```

Merge all
```{r}
ds <- 500
projected.sub <- lapply(projected.by.study, function(x) {
#    x <- subset(x, subset=functional.cluster %in% c("CD8_EffectorMemory","CD8_Tex"))
    #downsample?
    Idents(x) <- "dataset"
    subset(x, downsample = ds)
})

projected.merged.all <- Reduce(f = ProjecTILs:::merge.Seurat.embeddings, x = projected.sub)
saveRDS(projected.merged.all, "aux/Zheng.seurat.projected.ds.rds")
projected.merged.all <- readRDS("aux/Zheng.seurat.projected.ds.rds")

#Focus on Tex and Tem
projected.merged.Temex <- subset(projected.merged.all,
                                 subset=functional.cluster %in% c("CD8_EffectorMemory","CD8_Tex"))
                                
saveRDS(projected.merged.Temex, "aux/Zheng.seurat.projected.TexTem.ds.rds")
projected.merged.Temex <- readRDS("aux/Zheng.seurat.projected.TexTem.ds.rds")
```

View global embeddings
```{r}
palette <- c("#edbe2a", "#A58AFF", "#53B400", "#F8766D", 
                "#00B6EB", "#d1cfcc", "#FF0000", "#87f6a5", "#e812dd")

names(palette) <- levels(factor(ref.use$functional.cluster))

DefaultAssay(projected.merged.all) <- "integrated"
ndim <- dim(ref.use@misc$umap_object$data)[2]
projected.merged.all <- RunUMAP(projected.merged.all, dims = 1:ndim)
DimPlot(projected.merged.all, reduction = "umap", cols=palette, group.by = "functional.cluster")

#DimPlot(projected.merged.all, reduction = "umap", group.by = "dataset", split.by="dataset", ncol = 6) + NoLegend()

```
What are the outlier clusters?
```{r}
x <- projected.merged.all
npc <- 15
resol <- 0.3

x <- FindNeighbors(x, reduction = "pca", dims = 1:npc)
x <- FindClusters(x, resolution = resol)
x$cluster <- x@active.ident

DimPlot(x, group.by = "cluster", label = T) + NoLegend()
```

```{r}
DefaultAssay(x) <- 'RNA'
cluster.markers <- FindAllMarkers(x, only.pos = T, min.pct = 0.2, min.diff.pct=0.05, 
                                  logfc.threshold = 0.1, max.cells.per.ident = 1000, test.use="wilcox", base=exp(1))

all <- cluster.markers %>% group_by(cluster) %>% top_n(n = 50, wt = abs(avg_logFC))

for (i in levels(x@active.ident)) {
    print(subset(all, cluster==i))
}  
```


```{r fig.height=4}
DefaultAssay(projected.merged.all) <- "RNA"
pl <- FeaturePlot(projected.merged.all, combine = F, max.cutoff = 'q98',
            features=c("Cd8a","Cd4","Tcf7","Ccr7","Cd69","Gzmk","Gzmb","Havcr2","Lag3","Entpd1",
                       "Cxcr6","Mki67","Top2a","Anxa1","Gzmm","Spi1","Ifit3","Hsp90aa1","Sell")) 
pl <- lapply(pl, function(x) {
   x + scale_color_viridis(option="D", direction=1)
})
wrap_plots(pl)

```

View global embeddings of Tem and Tex cells
```{r}
palette <- c("#5E3C99","#FDB863")

DefaultAssay(projected.merged.Temex) <- "integrated"
ndim <- dim(ref.use@misc$umap_object$data)[2]
projected.merged.Temex <- RunUMAP(projected.merged.Temex, dims = 1:ndim)
DimPlot(projected.merged.Temex, reduction = "umap", cols=palette, group.by = "functional.cluster")

DimPlot(projected.merged.Temex, reduction = "umap", group.by = "dataset", split.by="dataset", ncol = 6) + NoLegend()

```

```{r fig.height=4}
DefaultAssay(projected.merged.Temex) <- "RNA"
pl <- FeaturePlot(projected.merged.Temex, combine = F, max.cutoff = 'q98',
            features=c("Ccr7","Gzmk","Gzmb","Cxcr3","Havcr2","Lag3","Entpd1","Cxcr6","Mki67","Top2a","Anxa1","Gzmm")) 
pl <- lapply(pl, function(x) {
   x + scale_color_viridis(option="D", direction=1)
})
wrap_plots(pl)

```


#Map functional cluster predictions back to original objects (work with human genes)
```{r}
studies.included <- names(projected.by.study)

gated.ann <- lapply(studies.included, function(n) {
    x <- gated.list[[n]]
    x$functional.cluster <- NA
    
    ann <- projected.by.study[[n]]$functional.cluster
    x$functional.cluster[names(ann)] <- ann
    
#    print(table(x$functional.cluster, useNA = "ifany"))

    x
})
names(gated.ann) <- names(projected.by.study)

saveRDS(gated.ann, "aux/Zheng.seurat.gated.annotated.rds")
```

Subset on Tex and T_EM only
```{r}
gated.sub <- lapply(gated.ann, function(x) {
    subset(x, subset=functional.cluster %in% c("CD8_EffectorMemory","CD8_Tex"))
})
saveRDS(gated.sub, "aux/Zheng.seurat.gated.annotated.Tex_Tem.rds")
```



Show ProjecTILs annotations
```{r fig.height=6, fig.width=12}
palette <- c("#edbe2a", "#A58AFF", "#53B400", "#F8766D", "#00B6EB")
names(palette) <- c("CD8_Tex","CD8_Tpex","CD8_EffectorMemory","CD8_EarlyActiv","CD8_NaiveLike")

pll <- lapply(names(gated.ann),
       FUN = function(x) {
          DimPlot(gated.ann[[x]], group.by="functional.cluster", cols = palette) + ggtitle(x)
       })

wrap_plots(pll)
ggsave("plots/Zheng.sets.by.functional.cluster.png", height=18, width=35)

```
```{r}
pll <- lapply(names(gated.ann),
       FUN = function(x) {
        tt <- t(table(zheng=gated.ann[[x]]$meta.cluster,projectils=gated.ann[[x]]$functional.cluster))
        ggplot(data = melt(tt), aes(x=zheng, y=projectils, fill=value)) + geom_tile()  + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
         
       })

wrap_plots(pll)
ggsave("plots/Zheng.vs.projectils.heatmaps.png", height=18, width=35)

```

```{r}
pll <- lapply(names(gated.sub),
       FUN = function(x) {
        tt <- (table(zheng=gated.sub[[x]]$meta.cluster,projectils=gated.sub[[x]]$functional.cluster))
        tt <- scale(tt,center = F, scale = colSums(tt))
        tt <- melt(tt)
        p <- ggplot(tt, aes(x = projectils, y = value, fill = zheng)) + 
            geom_bar(stat = "identity") + theme_bw()  + 
            theme(legend.position = "left") + ggtitle(x)
       
       })

wrap_plots(pll)
ggsave("plots/Zheng.vs.projectils.BARPLOT.Tex_T_EM.png", height=25, width=35)

```

```{r}

```
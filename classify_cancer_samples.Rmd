---
title: Classify T cells from multiple studies (human cancers)
author: "M. Andreatta <massimo.andreatta at unil.ch> and S. Carmona <santiago.carmona at unil.ch>"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
#output: html_notebook
---

```{r}
library(ggplot2)
library(Seurat)
library(UCell)
library(scGate)
#remotes::install_github("carmonalab/ProjecTILs", ref="518bd89")  #specify commit, for reproducibility

library(ProjecTILs)
library(SingleCellExperiment)
library(viridis)
```


We will use the collection of single-cell data by Zheng et al. (2021) Science, which covers 21 cancer types and 300 patients.

paper: https://www.science.org/doi/10.1126/science.abe6474
Data: https://zenodo.org/record/5461803#.YgT60GAo-eQ

```{r}
datapath <- "~/Dropbox/CSI/Datasets/Zhang_TIL_Science2021/expression/CD8/byDataset"

data.list <- list()
for (file in list.files(datapath)) {
  name <- gsub(pattern='.sce.rds', replacement = '', x=file)
  data.list[[name]] <- readRDS(sprintf("%s/%s",datapath,file))
}
names(data.list)
```

Convert to Seurat objects
```{r}
#For intial small tests
#data.list <- data.list[1:3]

tab <- ProjecTILs::Hs2Mm.convert.table

seurat.list <- lapply(X = seq_along(data.list),  
                    FUN=function(i) {
                        mainExpName(data.list[[i]]) <- 'RNA'
                        study.name <- names(data.list)[i]
                        study.id <- sprintf("S%02d",i)
                        
                        a <- names(assays(data.list[[i]]))
                        if ("counts" %in% a) {
                           counts.slot = "counts"
                        } else if ("log2TPM" %in% a) {
                           counts.slot = "log2TPM"
                        } else if ("norm_exprs" %in% a) {
                           counts.slot = "norm_exprs" 
                        }  
                        
                        #Use gene names for all objects (stored in display.name)
                        rownames(data.list[[i]]) <- rowData(data.list[[i]])[["display.name"]]  

                        r <- as.Seurat(data.list[[i]], counts = counts.slot, data = "norm_exprs", project=study.name)
                        r <- RenameCells(r, add.cell.id = study.id)

                        r
                    })
names(seurat.list) <- names(data.list)
```

```{r}
saveRDS(seurat.list, "aux/Zheng.seurat.list.rds")
seurat.list <- readRDS("aux/Zheng.seurat.list.rds")
```

Some QC
```{r eval=F, fig.height=4}
t(as.data.frame(lapply(seurat.list, dim)))

seu.downsampled <- lapply(seurat.list,
                          FUN=function(x) {
                             Idents(x) <- "dataset"
                             subset(x, downsample=1000)
                          })

seurat.merged <- Reduce(merge, seu.downsampled)
Idents(seurat.merged) <- "dataset"
seurat.merged <- AddMetaData(seurat.merged, metadata = PercentageFeatureSet(seurat.merged, pattern = "^RP[LS]"), col.name = "percent.ribo")
seurat.merged <- AddMetaData(seurat.merged, metadata = PercentageFeatureSet(seurat.merged, pattern = "^MT-"), col.name = "percent.mito")

VlnPlot(seurat.merged, features = c("nFeature_RNA", "nCount_RNA","percent.ribo","percent.mito"), ncol = 2, pt.size=0)

VlnPlot(seurat.merged, features = c("LCK", "SPI1","MS4A1","LYZ","CD2","CD3E","CD3G","CD8A","NCAM1"), pt.size=0, stack = T, flip=T)
ggsave("plots/Zheng.sets.violins.png", height=8, width=15)
```


Check some signatures for major cell types
```{r}
sigs <- list("Immune"=c("PTPRC"),
             "Myeloid"=c("SPI1"),
             "Tcell"=c("CD3D","CD3E","CD3G","CD2"),
             "Cd8T"=c("CD8A","CD8B","CD4-"),
             "Cd4T"=c("CD4","CD40LG"),
             "Treg"=c("CD4","FOXP3"),
             "Stromal"= c("MMP2","COL1A1","COL1A2","COL5A1","LUM","PDGFRA"),
             "Bcell" = c("CD79A","MS4A1","BANK1","PAX5","CD19"),
             "NK" = c("KLRD1","NKG7","NCR1","FCGR3A","CD3D-","CD3E-","CD3G-"),
             "MoMacDC" = c("LYZ","CSF1R","MSR1","MAFB","CD300E"),
             "Plasma_cell" = c("IGKC","IGHG3","IGHG1","IGHA1","CD19-"),
             "MAIT"=c("KLRB1", "SLC4A10", "NCR3")
             )


cycling.g1 <- scGate::genes.blacklist.default$Hs$cellCycle.G1S
cycling.g2 <- scGate::genes.blacklist.default$Hs$cellCycle.G2M
cycling <- c(cycling.g1, cycling.g2)

sigs$cycling = cycling

seurat.list <- lapply(seurat.list,
       FUN = function(x) {
          AddModuleScore_UCell(x, features = sigs, name=NULL, ncores=4)
       })

```

```{r fig.height=6}

for (type in names(sigs)) {
  
  pll <- lapply(names(seurat.list),
                FUN = function(x) {
                  cols = c("lightgrey", "blue")
                  if (sum(seurat.list[[x]][[type]])==0) {
                     cols = c("lightgrey", "lightgrey")
                  }
                  
                  FeaturePlot(seurat.list[[x]], features=c(type), max.cutoff = 'q99', cols=cols) + 
   #                 scale_color_viridis(option="D", direction=1) + 
                    ggtitle(sprintf("%s (%s)", x, type))
                })
  
  wrap_plots(pll)
  ggsave(sprintf("plots/Zheng.sets.UCell.scores.%s.png", type), height=18, width=25)
}
```
Filter CD8 T cells
```{r}
models <- scGate::get_scGateDB()
cd8.model <- models$human$generic$CD8T

#Add MAITs to model
cd8.model <- scGate::gating_model(cd8.model, level=4, negative=T, name="MAIT", signature = c("KLRB1", "SLC4A10", "NCR3"))

gated.list <- lapply(names(seurat.list),
       FUN = function(x) {
          print(sprintf("#Running dataset %s", x))
          scGate(seurat.list[[x]], model=cd8.model, ncores=4)
       })
names(gated.list) <- names(seurat.list)
```

Show results of gating per dataset
```{r fig.height=6}
cols = c("#10f87b","#fa765e")
names(cols) <- c("Pure","Impure")
pll <- lapply(names(gated.list),
       FUN = function(x) {
          DimPlot(gated.list[[x]], group.by="is.pure", cols = cols) + ggtitle(x)
       })

wrap_plots(pll)
ggsave("plots/Zheng.sets.gated.cd8t.png", height=18, width=25)

```

Show 'atlas' annotations
```{r fig.height=6, fig.width=12}
library(RColorBrewer)
cc <- lapply(gated.list, function(x) {
  unique(x$meta.cluster.coarse)
})
clusters <- unique(unlist(cc))

palette <- brewer.pal(n = 12, name = 'Paired')
names(palette) <- clusters
pll <- lapply(names(gated.list),
       FUN = function(x) {
          DimPlot(gated.list[[x]], group.by="meta.cluster.coarse", cols = palette) + ggtitle(x)
       })

wrap_plots(pll)
ggsave("plots/Zheng.sets.by.coarse.cluster.png", height=18, width=35)

```

Plot by sample/patient
```{r fig.height=10, fig.width=20}
pll <- lapply(names(gated.list),
       FUN = function(x) {
          DimPlot(gated.list[[x]], group.by="patient") + ggtitle(x)
       })

wrap_plots(pll)
ggsave("plots/Zheng.sets.by.patient.png", height=18, width=35)
```

Convert to `sce`?
```{r eval=F}
gated.sce <- lapply(gated.list, function(x){
      as.SingleCellExperiment(x)
})
```


Save results of scGate
```{r}
saveRDS(gated.list, "aux/Zheng.seurat.gated.rds")
gated.list <- readRDS("aux/Zheng.seurat.gated.rds")
```


Select pure cells and sufficiently large samples
```{r}
min.cells <- 200
large.samples <- lapply(names(gated.list),
       FUN = function(x) {
          gated.list[[x]] <- subset(gated.list[[x]], subset=is.pure=="Pure")
          gated.list[[x]] <- DietSeurat(gated.list[[x]], dimreducs = NULL, assays = "RNA")
          
          ss <- SplitObject(gated.list[[x]], split.by = 'patient')
          names(ss) <- paste0(x, "_", names(ss))
          
          ncells <- lapply(ss, ncol)
          ss <- ss[ncells>min.cells]
       })
large.samples <- unlist(large.samples, recursive = F)
names(large.samples)
```

Project individual samples in reference TIL atlas
```{r}
library(ProjecTILs)
ref <- load.reference.map()

#Focus on CD8 T cells
is.cd8 <- colnames(ref)[ref$functional.cluster %in% c("CD8_Tex","CD8_Tpex","CD8_EffectorMemory","CD8_EarlyActiv","CD8_NaiveLike")]

ref.cd8 <- subset(ref, cells=is.cd8)
#ref.cd8@misc$pca_object$x <- ref.cd8@misc$pca_object$x[is.cd8,]
#ref.cd8@misc$umap_object$layout <- ref.cd8@misc$umap_object$layout[is.cd8,]
#ref.cd8@misc$umap_object$data <- ref.cd8@misc$umap_object$data[is.cd8,]
plot.projection(ref.cd8)
```

Make projection
```{r}
#ref.use = ref
ref.use = ref.cd8

projected <- make.projection(large.samples, ref=ref.use, filter.cells = FALSE, skip.normalize = T, ncores=8)
#projected <- make.projection(large.samples[1:4], ref=ref.use, filter.cells = FALSE, skip.normalize = T, ncores=4)

projected <- lapply(projected, function(x) {
                      cellstate.predict(ref=ref.use, query=x)
                    })
```

Save results
```{r}
saveRDS(projected, "aux/Zheng.seurat.projected.rds")
projected <- readRDS("aux/Zheng.seurat.projected.rds")
```

```{r fig.height=10, fig.width=20}
pll <- lapply(names(projected),
       FUN = function(x) {
          plot.projection(projected[[x]], ref=ref.use) + NoLegend() + ggtitle(x)
       })

wrap_plots(pll)
ggsave("plots/Zheng.samples.projected.png", height=18, width=35)
```

```{r fig.height=4, fig.width=10}
genes <- c("Tcf7","Ccr7","Il7r","Cd4","Cd8a","Gzmb","Gzmk","Tox","Pdcd1","Lag3","Havcr2","Cx3cr1","Cxcl13")
ProjecTILs::plot.states.radar(ref=ref.use, query=projected[1:4], genes4radar = genes, min.cells = 50)
```


Merge results to visualize jointly and by study
```{r}
projected.merged <- Reduce(f = ProjecTILs:::merge.Seurat.embeddings, x = projected)
```

```{r}
plot.projection(projected.merged, ref=ref.use) + ggtitle("All studies")
```
FGlobal average profiles
```{r fig.height=4, fig.width=10}
genes <- c("Tcf7","Ccr7","Il7r","Cd4","Cd8a","Gzmb","Gzmk","Tox","Pdcd1","Lag3","Havcr2","Cx3cr1","Cxcl13")
ProjecTILs::plot.states.radar(ref=ref.use, query=projected.merged, genes4radar = genes, min.cells = 30)
```


Split by study
```{r}
projected.by.study <- SplitObject(projected.merged, split.by = "dataset")

pll <- lapply(names(projected.by.study),
       FUN = function(x) {
          plot.projection(projected.by.study[[x]], ref=ref.use) + NoLegend() + ggtitle(x)
       })

wrap_plots(pll)
ggsave("plots/Zheng.samples.projected.by.study.png", height=15, width=28)

```
Agreement between studies, and with reference expression profiles
```{r fig.height=4, fig.width=10}
genes <- c("Tcf7","Ccr7","Il7r","Cd4","Cd8a","Gzmb","Gzmk","Tox","Pdcd1","Lag3","Havcr2","Cx3cr1","Cxcl13")
a <- ProjecTILs::plot.states.radar(ref=ref.use, query=projected.by.study, genes4radar = genes, min.cells = 30, return = T)

ggsave("plots/radars.projected.by.study.png", plot = a, height=12, width=25)

```

---
title: Classify T cells from multiple studies (human cancers)
author: "Endika Prieto Fernandez <endikaprieto@vhio.net> and Massimo Andreatta <massimo.andreatta@unige.ch>"
date: "2025-11-27"
---

Libraries
```{r warning=F, message=F, results=F}

#library(renv)
#renv::restore()

library(ggplot2)
library(Seurat)
library(UCell)
library(scGate)
library(Biostrings)
library(ProjecTILs)
library(SingleCellExperiment)
library(viridis)
library(RColorBrewer)
library(msigdbr)
library(tibble)
library(dplyr)
library(fgsea)
library(corrplot)
library(ggpubr)
library(pheatmap)
library(stringr)
library(ggrepel)
library(patchwork)
library(readxl)
library(reshape2)
library(presto)
library(ggcorrplot)

palette <- c("CD8.NaiveLike" = "gray70",
             "CD8.CM" = "#E55454",
             "CD8.MAIT" = "#FFA500",
             "CD8.EM" = "#32CD32",
             "CD8.TEMRA" = "#00BFFF",
             "CD8.TPEX" = "#FF1493",
             "CD8.TEX" =  "#8A2BE2",
             "CD8.TerminallyExhausted" = "gray30")

```

## Data preparation

We will use the collection of single-cell data by [Zheng et al. (2021) Science](https://www.science.org/doi/10.1126/science.abe6474), which covers 21 cancer types and 300 patients.
The data can be downloaded from Zenodo: https://doi.org/10.5281/zenodo.5461803
Direct download link: https://zenodo.org/record/5461803/files/data.expression.tar.gz?download=1
```{r}

datapath <- "/Users/endikaprieto/Library/CloudStorage/OneDrive-VHIO/proteasome/bioinformatics/single-cell analysis/data/expression/CD8/byDataset"

data.list <- list()
for (file in list.files(datapath)) {
  name <- gsub(pattern='.sce.rds', replacement = '', x=file)
  data.list[[name]] <- readRDS(sprintf("%s/%s",datapath,file))
}
names(data.list)

```

Hematologic malignancies were eliminated to focus only on solid tumors, which is the main focus of the paper
```{r}

data.list <- data.list[!names(data.list) %in% c("AML.PeterVanGalen2019",
                                                "MM.thisStudy",
                                                "BCL.thisStudy")]

```

Convert to Seurat object
```{r}

seurat.list <- lapply(X = seq_along(data.list),  
                    FUN=function(i) {
                        mainExpName(data.list[[i]]) <- 'RNA'
                        study.name <- names(data.list)[i]
                        study.id <- sprintf("S%02d",i)
                        
                        a <- names(assays(data.list[[i]]))
                        if ("counts" %in% a) {
                           counts.slot = "counts"
                        } else if ("log2TPM" %in% a) {
                           counts.slot = "log2TPM"
                        } else if ("norm_exprs" %in% a) {
                           counts.slot = "norm_exprs" 
                        }  
    
                        rownames(data.list[[i]]) <- rowData(data.list[[i]])[["display.name"]]  
                        r <- as.Seurat(data.list[[i]], counts = counts.slot, data = "norm_exprs", project=study.name)
                        r <- RenameCells(r, add.cell.id = study.id)
                        r
                    })
names(seurat.list) <- names(data.list)

rm(data.list)
gc()

```

Check distributions of normalized counts
```{r}

gene <- "CD2"
pll <- lapply(names(seurat.list),
       function(x){
          df <- data.frame(counts = seurat.list[[x]]@assays$RNA@counts[gene,])
          ggplot(df, aes(x=counts)) + geom_histogram(bins=50) + ggtitle(x)
       })
wrap_plots(pll)

pll <- lapply(names(seurat.list),
       function(x){
          df <- data.frame(norm.data = seurat.list[[x]]@assays$RNA@data[gene,])
          ggplot(df, aes(x=norm.data)) + geom_histogram(bins=50) + ggtitle(x)
       })
wrap_plots(pll)

```

Data seems to be normalized in inconsistent way. Most datasets have expression of CD8A of ~3 on average while other subsets of ~9 on average. Try to correct by measuring 90% percentile of key genes.

Re-scale flagged datasets
```{r}

ref.factor <- 3
seurat.list <- lapply(seurat.list,
       function(x){
          df <- data.frame(x@assays$RNA@data[c("CD2","CD3E","CD3G","CD3D","CD8A","CD8B","PTPRC"),])
          q90 <- apply(df, 1, function(i){quantile(i, c(0.9))[1]})
          q90.mean <- mean(q90)
          print(sprintf("%s - %.3f", unique(x$dataset)[1], q90.mean))
          
          factor <- ref.factor / q90.mean
          #Rescale data with correction factor
          x@assays$RNA@data <- factor * x@assays$RNA@data
          x
       })

```

```{r}

pll <- lapply(names(seurat.list),
       function(x){
          df <- data.frame(norm.data = seurat.list[[x]]@assays$RNA@data["CD8A",])
          ggplot(df, aes(x=norm.data)) + geom_histogram(bins=50) + ggtitle(x)
       })
wrap_plots(pll)

```

Check some signatures for major cell types
```{r}

sigs <- list("Immune"=c("PTPRC"),
             "Myeloid"=c("SPI1"),
             "Tcell"=c("CD3D","CD3E","CD3G","CD2"),
             "Cd8T"=c("CD8A","CD8B","CD4-"),
             "Cd4T"=c("CD4","CD40LG"),
             "Treg"=c("CD4","FOXP3"),
             "Stromal"= c("MMP2","COL1A1","COL1A2","COL5A1","LUM","PDGFRA"),
             "Bcell" = c("CD79A","MS4A1","BANK1","PAX5","CD19"),
             "NK" = c("KLRD1","NKG7","NCR1","FCGR3A","CD3D-","CD3E-","CD3G-"),
             "MoMacDC" = c("LYZ","CSF1R","MSR1","MAFB","CD300E"),
             "Plasma_cell" = c("IGKC","IGHG3","IGHG1","IGHA1","CD19-"),
             "MAIT"=c("KLRB1", "SLC4A10", "NCR3"),
             "iNKT"=c("ZBTB16"),
             "KIR_NK"=c("TXK","KIR2DL3")
             )
cycling.g1 <- scGate::genes.blacklist.default$Hs$cellCycle.G1S
cycling.g2 <- scGate::genes.blacklist.default$Hs$cellCycle.G2M
cycling <- c(cycling.g1, cycling.g2)
sigs$cycling = cycling
seurat.list <- lapply(seurat.list,
       FUN = function(x) {
          AddModuleScore_UCell(x, features = sigs, name=NULL, ncores=8)
       })

```

Plot major cell signatures
```{r}

for (type in names(sigs)) {
  pll <- lapply(names(seurat.list),
                FUN = function(x) {
                  cols = c("lightgrey", "blue")
                  if (sum(seurat.list[[x]][[type]])==0) {
                     cols = c("lightgrey", "lightgrey")
                  }
                  
                  FeaturePlot(seurat.list[[x]], features=c(type), max.cutoff = 'q99', cols=cols) + 
                    ggtitle(sprintf("%s (%s)", x, type))
                })
  wrap_plots(pll)
  ggsave(sprintf("plots/Zheng.sets.UCell.scores.%s.png", type), height=18, width=25)
}

```

Filter CD8+ T cells
```{r}

models <- scGate::get_scGateDB()
cd8.model <- models$human$generic$CD8T

#Add MAITs to model
cd8.model <- scGate::gating_model(cd8.model, level=4, negative=T, name="MAIT", signature = c("KLRB1", "SLC4A10", "NCR3"))

gated.list <- lapply(names(seurat.list),
       FUN = function(x) {
          print(sprintf("#Running dataset %s", x))
          scGate(seurat.list[[x]], model=cd8.model, ncores=4, pca.dim = 30)
       })
names(gated.list) <- names(seurat.list)

rm(seurat.list)
gc()

```

Show results of gating per dataset
```{r}

cols = c("#10f87b","#fa765e")
names(cols) <- c("Pure","Impure")
pll <- lapply(names(gated.list),
       FUN = function(x) {
          DimPlot(gated.list[[x]], group.by="is.pure", cols = cols) + ggtitle(x)
       })
wrap_plots(pll)
ggsave("plots/Zheng.sets.gated.cd8t.png", height=18, width=35)

```

Show original annotations
```{r}

cc <- lapply(gated.list, function(x) {
  unique(x$meta.cluster.coarse)
  })
clusters <- unique(unlist(cc))
palette <- brewer.pal(n = 12, name = 'Paired')
names(palette) <- clusters
pll <- lapply(names(gated.list),
       FUN = function(x) {
          DimPlot(gated.list[[x]], group.by="meta.cluster.coarse", cols = palette) + ggtitle(x)
       })
wrap_plots(pll)
ggsave("plots/Zheng.sets.by.coarse.cluster.png", height=18, width=35)

```

Plot by sample/patient
```{r}

pll <- lapply(names(gated.list),
       FUN = function(x) {
          DimPlot(gated.list[[x]], group.by="patient") + ggtitle(x)
       })
wrap_plots(pll)
ggsave("plots/Zheng.sets.by.patient.png", height=18, width=35)

```

Select pure cells and sufficiently large samples
```{r}

min.cells <- 200
large.samples <- lapply(names(gated.list),
       FUN = function(x) {
          tmp <- subset(gated.list[[x]], subset=is.pure=="Pure")
          tmp <- DietSeurat(tmp, dimreducs = NULL, assays = "RNA")
          ss <- SplitObject(tmp, split.by = 'patient')
          names(ss) <- paste0(x, "_", names(ss))
          ncells <- lapply(ss, ncol)
          ss <- ss[ncells>min.cells]
          ss
       })
large.samples <- unlist(large.samples, recursive = F)
names(large.samples)

```

Make projection
Direct download link: https://figshare.com/articles/dataset/ProjecTILs_human_reference_atlas_of_CD8_tumor-infiltrating_T_cells_CD8_TIL_version_1/23608308
```{r}

ref.use <- load.reference.map(ref = "/Users/endikaprieto/Library/CloudStorage/OneDrive-VHIO/pbl/single_cell/refs/projecTILs/CD8T_human_ref_v1.rds")

projected <- make.projection(large.samples, ref=ref.use, filter.cells = FALSE, skip.normalize = T, ncores=8)
projected <- lapply(projected, function(x) {
                      cellstate.predict(ref=ref.use, query=x)
                    })

```

Plot projections by study
```{r fig.height=30, fig.width=40}

pll <- lapply(names(projected),
       FUN = function(x) {
          plot.projection(projected[[x]], ref=ref.use) + NoLegend() + ggtitle(x)
       })
wrap_plots(pll)

ggsave("plots/Zheng.samples.projected.png", height=40, width=50, limitsize = FALSE)

gc()

```

IMPORTANT:
Focus on 10x/in drop technologies to have more homogeneous and comparable gene expression across datasets
Also exclude the Melanoma.MosheSade-Feldman2018 study because some samples come from LN but all are marked as tumor
```{r}

studies <- names(gated.list)

LN.samples <- "MELA.MosheSade-Feldman2018"
TPM.tech <- c("CHOL.thisStudy", "CRC.LeiZhang2018", "HCC.ChunhongZheng2017", "HCC.QimingZhang2019_SS2", "MELA.LivnatJerby-Arnon2018", "LC.XinyiGuo2018")

studies <- setdiff(studies, LN.samples)
studies <- setdiff(studies, TPM.tech)

```

Merge results by study to visualize jointly 
```{r}

matches <- lapply(studies,
                  function(s) {
                    match <- grep(pattern=s, x=names(projected))
                    match
                    })
names(matches) <- studies
matches <- matches[lapply(matches,length)>0]
projected.by.study <- lapply(names(matches),
                             function(s) {
                               x <- matches[[s]]
                               print(sprintf("%s - merging %i sets",s, length(x)))
                               if (length(x) == 1) {
                                  projected[[x]]
                               } else {
                                  Reduce(f = ProjecTILs:::merge.Seurat.embeddings, x = projected[x])
                               }
                             })
names(projected.by.study) <- names(matches)
length(projected.by.study)                        
names(projected.by.study)

rm(projected)
gc()

```

Plot projections by study
```{r fig.height=15, fig.width=20}

pll <- lapply(names(projected.by.study),
       FUN = function(x) {
          plot.projection(projected.by.study[[x]], ref=ref.use, pointsize = 0.5, linesize = 0.5) + NoLegend() + ggtitle(x)
       })
wrap_plots(pll)

ggsave("plots/Zheng.by.study.ProjecTILs.pdf", height=22, width=25)

```

Merge all and downsample to max 3000 cells per dataset
```{r}

ds <- 3000
projected.sub <- lapply(projected.by.study, function(x) {
  Idents(x) <- "dataset"
  subset(x, downsample = ds)
})
projected.merged.all <- Reduce(f = ProjecTILs:::merge.Seurat.embeddings, x = projected.sub)

```

Gene signatures
```{r}

gene.signatures <- list(
  "exhaustion" = c("TCF7","CCR7","IL7R","CD4","CD8A","GZMB","GZMK","TOX","PDCD1","LAG3","HAVCR2","CX3CR1","CXCL13"),
  "proteasome" = c("PSMA1","PSMA2","PSMA3","PSMA4","PSMA5","PSMA6","PSMA7","PSMB1","PSMB2","PSMB3","PSMB4","PSMB5","PSMB6","PSMB7","PSMC1","PSMC2","PSMC3","PSMC4","PSMC5","PSMC6","PSMD1","PSMD2","PSMD3","PSMD4","PSMD6","PSMD7","PSMD8","PSMD11","PSMD12","PSMD13","PSMD14"),
  "inducible.proteasome" = c("PSMB8", "PSMB9", "PSMB10"),
  "thymoproteasome" = c("PSMB11"),
  "chaperones" = c("PSMG2", "POMP", "PSMD9"),
  "PA28" = c("PSME1", "PSME2", "PSME3"),
  "PA200" = c("PSME4"),
  "iTEX" = c("PDCD1", "HAVCR2", "LAG3", "CTLA4", "ENTPD1", "TNFRSF9", "TNFRSF4", "CCL3", "CXCL13", "CRTAM", "TOX", "TCF7-", "IFNG-", "TNF-")
)

DefaultAssay(projected.merged.all) <- "RNA"
projected.merged.all <- AddModuleScore_UCell(projected.merged.all , features = gene.signatures)
signature.names <- paste0(names(gene.signatures), "_UCell")

```

Additional classifications:

Chu et al. Nat Med 2023: https://doi.org/10.1038/s41591-023-02371-y
Direct download link: https://static-content.springer.com/esm/art%3A10.1038%2Fs41591-023-02371-y/MediaObjects/41591_2023_2371_MOESM3_ESM.xlsx
```{r}

gene.list <- read_excel("41591_2023_2371_MOESM3_ESM.xlsx", sheet = 5, skip = 1, col_names = TRUE)
colnames(gene.list)

classification <- list()

for (i in colnames(gene.list)){
  a <- gene.list[[i]]
  a <- as.character(na.omit(a))
  classification[[as.character(paste0("Chu_", i))]] <- a
}

DefaultAssay(projected.merged.all) <- "RNA"
projected.merged.all <- AddModuleScore_UCell(projected.merged.all , features = classification)
classification.names <- paste0(names(classification), "_UCell")

```

Terminally exhausted cells
```{r}

# Calculate the 95th percentile of iTEX_UCell
percentile_95 <- quantile(projected.merged.all$iTEX_UCell, 0.95)

projected.merged.all$functional.cluster.2 <- ifelse(projected.merged.all$iTEX_UCell >= percentile_95,
                                                    "CD8.TerminallyExhausted",
                                                    projected.merged.all$functional.cluster)

```

Recalculate embeddings
```{r}

DefaultAssay(projected.merged.all) <- "integrated"
projected.merged.all <- RunUMAP(projected.merged.all, dims = 1:10)

```

Internal controls:

Map functional cluster predictions back to original objects (work with human genes)
```{r}

studies.included <- names(projected.by.study)
gated.ann <- lapply(studies.included, function(n) {
    x <- gated.list[[n]]
    x$functional.cluster <- NA
    ann <- projected.by.study[[n]]$functional.cluster
    x$functional.cluster[names(ann)] <- ann
    x
})
names(gated.ann) <- names(projected.by.study)

```

Show ProjecTILs annotations
```{r}

pll <- lapply(names(gated.ann),
       FUN = function(x) {
          DimPlot(gated.ann[[x]], group.by="functional.cluster", cols = palette) + ggtitle(x)
       })

wrap_plots(pll)
ggsave("plots/Zheng.sets.by.functional.cluster.pdf", height=18, width=35)

```

Confirm coherence between ProjecTILs and original annotations
```{r}

library(reshape2)

pll <- lapply(names(gated.ann), function(x) {
  tt <- t(table(
    zheng = gated.ann[[x]]$meta.cluster,
    projectils = gated.ann[[x]]$functional.cluster
  ))
  ggplot(data = reshape2::melt(tt), 
         aes(x = zheng, y = projectils, fill = value)) + 
    geom_tile() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
})

wrap_plots(pll)
ggsave("plots/Zheng.vs.projectils.heatmaps.pdf", height = 18, width = 35)

```

Check Texem markers
```{r}

typical.Texem <- c("TOX","ENTPD1","CXCL13","CTLA4","HAVCR2","LAG3","PDCD1","IL7R", "TCF7", "GZMK","GZMM", "ANXA1", "CCL5", "ITGAM", "ENTPD1")

DefaultAssay(projected.merged.all) <- "RNA"

pll <- FeaturePlot(projected.merged.all, combine = F, max.cutoff = 'q98',
            features=typical.Texem) 

pll <- lapply(pll, function(x) {
   x + scale_color_viridis(option="D", direction=1, begin=0.2) + 
      theme(aspect.ratio = 1, axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())
})

wrap_plots(pll)
ggsave("plots/Zheng.markers.integrated.UMAP.pdf", height=20, width=20)

```

Check phenotype markers
```{r}

phenotype.markers <- c("CD8A","CD4","TCF7","CCR7","CD69","GZMK","GZMB","HAVCR2","LAG3","ENTPD1","CXCR6","MKI67","TOP2A","ANXA1","GZMM","ZBTB16","HIVEP3","IFIT3","HSP90AA1","SELL")

DefaultAssay(projected.merged.all) <- "RNA"

pll <- FeaturePlot(projected.merged.all, combine = F, max.cutoff = 'q98',
            features=phenotype.markers)

pll <- lapply(pll, function(x) {
   x + scale_color_viridis(option="D", direction=1, begin=0.2) + 
      theme(aspect.ratio = 1, axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())
})

wrap_plots(pll)
ggsave("plots/Zheng.markers.phenotype.pdf", width = 20, height = 20)

```

Check Chu signatures
```{r}

classification.names <- gsub(" ", ".", classification.names)

DefaultAssay(projected.merged.all) <- "RNA"

pll <- FeaturePlot(projected.merged.all, combine = F, max.cutoff = 'q98',
            features=classification.names)

pll <- lapply(pll, function(x) {
   x + scale_color_viridis(option="D", direction=1, begin=0.2) + 
      theme(aspect.ratio = 1, axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())
})

wrap_plots(pll)
ggsave("plots/Zheng.Chu.signatures.pdf", width = 20, height = 15)

```

# Plots

### Fig. 1a

Plot by study
```{r}

nb.cols <- 22

my.colors <- colorRampPalette(brewer.pal(8, "Set1"))(nb.cols)
DimPlot(projected.merged.all, reduction = "umap", pt.size = 0.1, cols=my.colors, group.by = "dataset") + theme(aspect.ratio = 1) + NoLegend()

ggsave("figs/fig1a.by.study.pdf", height = 10, width = 10)

```

Plot by Seurat cluster
```{r}

levels(factor(projected.merged.all$functional.cluster))
DimPlot(projected.merged.all, reduction = "umap", pt.size = 0.1, cols=palette, group.by = "functional.cluster.2") + theme(aspect.ratio = 1) + NoLegend()

ggsave("figs/fig1a.by.pheno.pdf", height = 10, width = 10)

```

Plot by Seurat cluster (split)
```{r}

DimPlot(projected.merged.all, group.by = "functional.cluster.2", split.by = "functional.cluster.2", cols= palette, pt.size = 0.1) + theme(aspect.ratio = 1) + NoLegend()

ggsave("figs/fig1a.by.pheno.split.pdf", width=25, height=25)

```

### Fig. 1b

Expression of typical phenotypic markers
```{r}

# Set the order of identities in the Seurat object
my.order <- c("CD8.NaiveLike", "CD8.CM", "CD8.MAIT", "CD8.EM", "CD8.TEMRA", "CD8.TPEX", "CD8.TEX", "CD8.TerminallyExhausted")
projected.merged.all.order <- projected.merged.all
projected.merged.all.order$functional.cluster.2 <- factor(projected.merged.all$functional.cluster.2, levels = my.order)

DefaultAssay(projected.merged.all.order) <- "RNA"

genes <- c("SELL", "TCF7", "LEF1", "CCR7", "S1PR1", "LMNA", "IL7R", "GZMK", "FGFBP2",
    "FCGR3A", "XCL1", "XCL2", "CD200", "CRTAM", "GNG4", "TOX", "PDCD1", "HAVCR2",
    "GZMB", "PRF1", "LAG3", "KLRB1", "TRAV1-2")

DotPlot(projected.merged.all.order, group.by = "functional.cluster.2", features = genes, cols="RdBu", scale=T, col.max=1.5) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  theme(aspect.ratio = 0.5)
  
ggsave("figs/fig1b.dotplot.phenotype.pdf", width=9, height=9)

```

### Fig. 1c

```{r}

projected.merged.all$functional.cluster.2 <- factor(projected.merged.all$functional.cluster.2, levels = my.order)

# Chu_Exhaustion_UCell
vals <- FetchData(projected.merged.all, vars = "Chu_Exhaustion_UCell")[,1]
global_min <- quantile(vals, 0.50)
global_max <- quantile(vals, 0.95) 

pll <- FeaturePlot(projected.merged.all, combine = F, max.cutoff = 'q95', min.cutoff = 'q50',
                   features = c("Chu_Exhaustion_UCell"), split.by = "functional.cluster.2", pt.size = 0.25)
pll <- lapply(pll, function(x) {
   x + scale_color_viridis(option="D", direction=1, begin=0.1, limits = c(global_min, global_max)) + 
      theme(aspect.ratio = 1, axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())
})
pll <- wrap_plots(pll, ncol = 8)

# Chu_Stress_response_UCell
vals <- FetchData(projected.merged.all, vars = "Chu_Stress_response_UCell")[,1]
global_min <- quantile(vals, 0.50)
global_max <- quantile(vals, 0.95) 

qll <- FeaturePlot(projected.merged.all, combine = F, max.cutoff = 'q95', min.cutoff = 'q50',
                   features = c("Chu_Stress_response_UCell"), split.by = "functional.cluster.2", pt.size = 0.25)
qll <- lapply(qll, function(x) {
   x + scale_color_viridis(option="D", direction=1, begin=0.1, limits = c(global_min, global_max)) + 
      theme(aspect.ratio = 1, axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())
})
qll <- wrap_plots(qll, ncol = 8)

wrap_plots(pll, qll, nrow = 2)
ggsave("figs/fig1c.pdf", width=25, height=15)

```

### Fig. 1d

Volcano plot
```{r warning=FALSE}

phenotypes <- names(palette)
pairwise_combinations <- list()
counter <- 1
for(i in seq_along(phenotypes)) {
  for(j in seq_along(phenotypes)) {
    if(i != j) {
      pairwise_combinations[[counter]] <- c(phenotypes[i], phenotypes[j])
      counter <- counter + 1
    }
  }
}

plot_list <- list()
proteasome_genes_list <- list()
for (comb in pairwise_combinations) {
  cluster1 <- comb[1]
  cluster2 <- comb[2]
  current_cluster_data <- subset(projected.merged.all, functional.cluster.2 %in% comb)
  markers.genes <-wilcoxauc(X = current_cluster_data, 'functional.cluster.2')
  markers.genes$log10p <- -log10(markers.genes$padj)
  dplyr::count(markers.genes, group)
  markers.genes <- markers.genes %>%
    dplyr::filter(group == cluster2) %>%
    arrange(desc(logFC)) %>%
    dplyr::select(feature, logFC,log10p)
'%!in%' <- function(x,y)!('%in%'(x,y))
  proteasome.signature <- c(gene.signatures$proteasome, gene.signatures$inducible.proteasome, gene.signatures$chaperones, gene.signatures$PA28, gene.signatures$PA200)
  exhaustion.signature <- c(gene.signatures$exhaustion)
  volcano <- markers.genes %>% 
    mutate(
      cond = case_when( 
        logFC >= 0.1 & log10p >= 1.30103 & feature %in% proteasome.signature ~ "orange2",
        logFC >= 0.1 & log10p >= 1.30103 & feature %!in% proteasome.signature ~ "black",
        logFC < -0.1 & log10p >= 1.30103 ~ "black",
        TRUE ~ "gray70"),
      order = case_when(
        feature %in% proteasome.signature ~ "2",
        TRUE ~ "1"
        )
    )
  count.prot.genes <- volcano$feature[volcano$cond == "orange2"]
  proteasome_genes_list[[as.character(paste(comb, collapse = "_vs_"))]] <- count.prot.genes
  plot_name <- paste0(cluster1, "_vs_", cluster2)
  volcano <- arrange(volcano, order)
  labels <- c(proteasome.signature)
  pll <- ggplot(volcano, aes(x= logFC, y= log10p)) + 
    geom_point(color= volcano$cond, size = ifelse(volcano$cond == "orange2", 2.5, 0.2)) +
    geom_text_repel(aes(label=ifelse(volcano$cond == "orange2", as.character(feature), '')),
                  hjust=1.25,
                  fontface= 3,
                  max.overlaps = 8000) +
    xlab(bquote(~log[2]~'FC')) + 
    xlim(c(-1.15,1.15)) +
    ylim(c(0,300)) +
    ylab(bquote(~-log[10]~'padj')) +
    geom_hline(yintercept=-log10(0.05),linetype="dashed",col="black") +
    geom_vline(xintercept=0.1,linetype="dashed",col="black") +
    geom_vline(xintercept=-0.1,linetype="dashed",col="black") +
    theme(axis.line = element_line(color='black', size=0.5), panel.border = element_rect(color='black', size=0.5, fill=NA), panel.background = NULL) +
    theme(aspect.ratio = 1, plot.title = element_text(size = 8))
  print(plot_name)
  plot_list[[plot_name]] <- pll + ggtitle(plot_name)
  write.table(volcano, file = file.path("figs/fig1d.volcano/", paste0("volcanos_", plot_name, ".txt")))
}

```

DEG counter
```{r}

# Count
deg_number <- list()
deg_genes <- list()

for (i in list.files("figs/fig1d.volcano")) {
  deg_i <- read.table(file.path("figs/fig1d.volcano", i)) %>% filter(cond == "orange2")
  deg_number[[sub("^volcanos_", "", sub("\\.txt$", "", i))]] <-  length(deg_i$feature)
  deg_genes[[sub("^volcanos_", "", sub("\\.txt$", "", i))]] <-  deg_i$feature
}
  
deg_proteasome_genes <- sort(unique(unlist(deg_genes)))
deg_proteasome_genes

```

Visualization
```{r}

phenotype_order <- names(palette)

comparisons <- names(deg_number)
split_comp <- strsplit(comparisons, "_vs_")
rows <- sapply(split_comp, `[`, 1)
cols <- sapply(split_comp, `[`, 2)
values <- unlist(deg_number)

deg_matrix <- matrix(0,
                     nrow = length(phenotype_order),
                     ncol = length(phenotype_order),
                     dimnames = list(phenotype_order, phenotype_order))

for(i in seq_along(values)) {
  r <- rows[i]
  c <- cols[i]
  v <- values[i]
  if(r %in% phenotype_order & c %in% phenotype_order) {
    deg_matrix[r, c] <- v
  }
}
diag(deg_matrix) <- 0
deg_matrix
write.table(deg_matrix, file = file.path("figs/fig1d.volcano.pos.dge.txt"), sep = "\t")

```

### Fig. 1e

Make heatmap function
```{r}

my.colors <- colorRampPalette(brewer.pal(8, "Set1"))(nb.cols)

make.heatmap <- function(data, assay="RNA", genes, method=c("ward.D", "average"), brewer.palette="PRGn") {
  set.seed(123)
  m <- list()
  for (g in unique(genes)) {
    if (!g %in% rownames(data@assays[[assay]]@data)) {
      warning("Gene not found in assay: ", g)
      next
    }
    vals <- as.numeric(data@assays[[assay]]@data[g, ])
    m[[g]] <- tapply(vals, data$subset_dataset_patient, mean, na.rm = TRUE)
  }
  if (length(m) == 0) stop("No genes found in assay")
  m <- as.data.frame(m, stringsAsFactors = FALSE)
  m.study <- factor(sapply(strsplit(rownames(m), "@", perl = TRUE), `[`, 2))
  m.subset_raw <- sapply(strsplit(rownames(m), "@", perl = TRUE), `[`, 1)
  m.subset <- factor(m.subset_raw, levels = levels(data$functional.cluster.2))
  keep <- !is.na(m.subset) & !is.na(m.study)
  if (any(!keep)) {
    warning("Removing rows with NA in subset or study: ", paste(rownames(m)[!keep], collapse = ", "))
    m <- m[keep, , drop = FALSE]
    m.study <- m.study[keep]
    m.subset <- m.subset[keep]
  }
  if (nrow(m) == 0) stop("No rows left after filtering")
  ord <- order(m.subset, m.study)
  m <- m[ord, , drop = FALSE]
  m.study <- m.study[ord]
  m.subset <- m.subset[ord]
  breaksList <- seq(-2, 2, by = 0.25)
  color <- colorRampPalette(rev(brewer.pal(n = 7, name = brewer.palette)))(length(breaksList))
  rle_sub <- rle(as.character(m.subset))
  gaps_col <- cumsum(rle_sub$lengths)
  if (length(gaps_col) > 0) gaps_col <- gaps_col[-length(gaps_col)]
  annotation_col <- data.frame(Study = m.study, TIL_Subtype = m.subset)
  rownames(annotation_col) <- rownames(m)
  present_subtypes <- unique(as.character(m.subset))
  if (exists("palette")) {
    missing_colors <- setdiff(present_subtypes, names(palette))
    if (length(missing_colors) > 0) warning("Clusters without a defined color in the palette: ", paste(missing_colors, collapse = ", "))
    palette1 <- palette[intersect(names(palette), present_subtypes)]
  } else {
    palette1 <- setNames(colorRampPalette(brewer.pal(8, "Set1"))(length(present_subtypes)), present_subtypes)
  }
  present_studies <- unique(as.character(m.study))
  palette2 <- setNames(colorRampPalette(brewer.pal(8, "Set1"))(length(present_studies)), present_studies)
  h <- pheatmap::pheatmap(t(m),
                          cluster_rows = FALSE,
                          cluster_cols = FALSE,
                          scale = "row",
                          breaks = breaksList,
                          color = color,
                          annotation_col = annotation_col,
                          gaps_col = gaps_col,
                          show_colnames = FALSE,
                          annotation_colors = list(TIL_Subtype = palette1, Study = palette2),
                          fontsize_row = 6,
                          fontsize = 7,
                          cellheight = 5,
                          clustering_method = method[1])
  return(h)
}

```

Heatmap proteasome genes
```{r r fig.height=8, fig.width=30}

# Proteasome
genes.of.interest <- gene.signatures$proteasome
data.heat <- projected.merged.all
DefaultAssay(data.heat) <- "RNA"
data.heat$dataset_patient <- paste0(data.heat$dataset, "@", data.heat$patient)
data.heat$subset_dataset_patient <- paste0(data.heat$functional.cluster.2, "@", data.heat$dataset_patient)
h <- make.heatmap(data.heat, genes=genes.of.interest, brewer.palette = "RdBu")
ggsave(plot = h, "figs/fig1e.heatmap.proteasome.pdf", width = 15)
  
# Inducible proteasome
genes.of.interest <- gene.signatures$inducible.proteasome
data.heat <- projected.merged.all
DefaultAssay(data.heat) <- "RNA"
data.heat$dataset_patient <- paste0(data.heat$dataset, "@", data.heat$patient)
data.heat$subset_dataset_patient <- paste0(data.heat$functional.cluster.2, "@", data.heat$dataset_patient)
h <- make.heatmap(data.heat, genes=genes.of.interest, brewer.palette = "RdBu")
ggsave(plot = h, "figs/fig1e.heatmap.inducible.proteasome.pdf", width = 15)

# Chaperones
genes.of.interest <- gene.signatures$chaperones
data.heat <- projected.merged.all
DefaultAssay(data.heat) <- "RNA"
data.heat$dataset_patient <- paste0(data.heat$dataset, "@", data.heat$patient)
data.heat$subset_dataset_patient <- paste0(data.heat$functional.cluster.2, "@", data.heat$dataset_patient)
h <- make.heatmap(data.heat, genes=genes.of.interest, brewer.palette = "RdBu")
ggsave(plot = h, "figs/fig1e.heatmap.chaperones.pdf", width = 15)

# PA28
genes.of.interest <- gene.signatures$PA28
data.heat <- projected.merged.all
DefaultAssay(data.heat) <- "RNA"
data.heat$dataset_patient <- paste0(data.heat$dataset, "@", data.heat$patient)
data.heat$subset_dataset_patient <- paste0(data.heat$functional.cluster.2, "@", data.heat$dataset_patient)
h <- make.heatmap(data.heat, genes=genes.of.interest, brewer.palette = "RdBu")
ggsave(plot = h, "figs/fig1e.heatmap.PA28.pdf", width = 15)

# PA200
genes.of.interest <- gene.signatures$PA200
data.heat <- projected.merged.all
DefaultAssay(data.heat) <- "RNA"
data.heat$dataset_patient <- paste0(data.heat$dataset, "@", data.heat$patient)
data.heat$subset_dataset_patient <- paste0(data.heat$functional.cluster.2, "@", data.heat$dataset_patient)
h <- make.heatmap(data.heat, genes=genes.of.interest, brewer.palette = "RdBu")
ggsave(plot = h, "figs/fig1e.heatmap.PA200.pdf", width = 15)

```

Dotplot proteasome
```{r} 

genes.of.interest <- c(gene.signatures$proteasome, gene.signatures$inducible.proteasome, gene.signatures$chaperones, gene.signatures$PA200, gene.signatures$PA28)

DotPlot(projected.merged.all.order, group.by = "functional.cluster.2", features = genes.of.interest, cols="RdBu", scale=T, col.max=1.5) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  theme(aspect.ratio = 0.5)

ggsave("figs/fig1e.dotplot.proteasome.pdf", width = 12.5, height=5)
 
```

### Fig. 1f

Correlation plots
```{r}

cor.plot <- as.data.frame(projected.merged.all$Chu_Exhaustion_UCell)
cor.plot$`Chu_Stress response_UCell` <- projected.merged.all$`Chu_Stress_response_UCell`
cor.plot$proteasome_UCell <- projected.merged.all$proteasome_UCell
cor.plot$inducible.proteasome_UCell <- projected.merged.all$inducible.proteasome_UCell
cor.plot$functional.cluster.2 <- projected.merged.all$functional.cluster.2
colnames(cor.plot) <- c("Chu_Exhaustion_UCell", "Chu_Stress_response_UCell", "proteasome_UCell", "inducible.proteasome_UCell ","functional.cluster.2")

pll.1 <- ggscatter(cor.plot, x= "proteasome_UCell", y = "Chu_Stress_response_UCell",
          add = "reg.line", conf.int = TRUE, combine= TRUE,
          cor.coef = FALSE, cor.method = "pearson",
          add.params = list(color = "black"),
          xlab = "proteasome_UCell", ylab = "Chu_Stress_response_UCell",
          color = "functional.cluster.2",
          palette = palette,
          size = 2,
          shape = 3,
          fullrange = FALSE) + 
  stat_cor() +
  theme(aspect.ratio = 1)

ggsave("figs/fig1f.cor.stress.vs.proteasome.pdf", height = 10)

```

### Fig. 1g

Gene set enrichment analysis (GSEA)
In order to perform the GSEA the annotated gene set is needed. One popular source is the MsigDB from Broad Institute.
https://www.gsea-msigdb.org/gsea/msigdb/index.jsp
We focused on TEX (named Terminally exhausted) and TEMRA (named CD8.TEMRA) in functional.cluster.2 of projected.merged.all

GSEA analysis
```{r}

projected.merged.comparisson <- subset(projected.merged.all, subset = functional.cluster.2  %in% c("CD8.TerminallyExhausted", "CD8.TEMRA"))

markers.genes <- wilcoxauc(X = projected.merged.comparisson, 'functional.cluster.2')
markers.genes$log10p <- -log10(markers.genes$padj)
dplyr::count(markers.genes, group)
markers.genes <- markers.genes %>%
  dplyr::filter(padj <= 0.05) %>%
  dplyr::filter(group == "CD8.TerminallyExhausted") %>%
  arrange(desc(logFC)) %>%
  dplyr::select(feature, logFC,log10p)
ranks<- deframe(markers.genes)
head(ranks)
barplot(sort(ranks, decreasing = T))

```

H
```{r}

m_df<- msigdbr(species = "Homo sapiens", category = "H")
head(m_df)
fgsea_sets <- m_df %>% split(x = .$gene_symbol, f = .$gs_name)
names(ranks) <- toupper(names(ranks))
fgseaRes<- fgseaMultilevel(fgsea_sets, ranks, minSize=15, maxSize = 500)
head(fgseaRes[order(padj, -abs(NES)), ], n=50)
write.table(fgseaRes[,c(1:7)], "gsea/gsea_pathways_H.tsv", sep = "\t", row.names = F)

# Filter results to find pathways involved in hypoxia|proteasom|stress|exhaustion
filtered_fgseaRes <- fgseaRes[grepl("HYPOXIA|PROTEASOM|STRESS|EXHAUSTION", fgseaRes$pathway), ]
filtered_fgseaRes$pathway <- fgseaRes$pathway[grepl("HYPOXIA|PROTEASOM|STRESS|EXHAUSTION", fgseaRes$pathway)]
filtered_fgseaRes[order(filtered_fgseaRes$pval), ]

```

C2
```{r}

m_df<- msigdbr(species = "Homo sapiens", category = "C2")
head(m_df)
fgsea_sets <- m_df %>% split(x = .$gene_symbol, f = .$gs_name)
names(ranks) <- toupper(names(ranks))
fgseaRes<- fgseaMultilevel(fgsea_sets, ranks, minSize=15, maxSize = 500)
head(fgseaRes[order(padj, -abs(NES)), ], n=200)
write.table(fgseaRes[,c(1:7)], "gsea/gsea_pathways_C2.tsv", sep = "\t", row.names = F)

# Filter results to find pathways involved in hypoxia|proteasom|stress|exhaustion
filtered_fgseaRes <- fgseaRes[grepl("OXYGEN", fgseaRes$pathway), ]
filtered_fgseaRes$pathway <- fgseaRes$pathway[grepl("OXYGEN", fgseaRes$pathway)]
filtered_fgseaRes[order(filtered_fgseaRes$pval), ]

```

C5
```{r}

m_df<- msigdbr(species = "Homo sapiens", category = "C5")
head(m_df)
fgsea_sets <- m_df %>% split(x = .$gene_symbol, f = .$gs_name)
names(ranks) <- toupper(names(ranks))
fgseaRes<- fgseaMultilevel(fgsea_sets, ranks, minSize=15, maxSize = 500)
head(fgseaRes[order(padj, -abs(NES)), ], n=200)
write.table(fgseaRes[,c(1:7)], "gsea/gsea_pathways_C5.tsv", sep = "\t", row.names = F)

# Filter results to find pathways involved in hypoxia|proteasom|stress|exhaustion
filtered_fgseaRes <- fgseaRes[grepl("HYPOXIA|PROTEASOM|STRESS|EXHAUSTION", fgseaRes$pathway), ]
filtered_fgseaRes$pathway <- fgseaRes$pathway[grepl("HYPOXIA|PROTEASOM|STRESS|EXHAUSTION", fgseaRes$pathway)]
filtered_fgseaRes[order(filtered_fgseaRes$pval), ]

```
C7
```{r}

m_df<- msigdbr(species = "Homo sapiens", category = "C7")
head(m_df)
fgsea_sets <- m_df %>% split(x = .$gene_symbol, f = .$gs_name)
names(ranks) <- toupper(names(ranks))
fgseaRes<- fgseaMultilevel(fgsea_sets, ranks, minSize=15, maxSize = 500)
head(fgseaRes[order(padj, -abs(NES)), ], n=200)
write.table(fgseaRes[,c(1:7)], "gsea/gsea_pathways_C7.tsv", sep = "\t", row.names = F)

# Filter results to find pathways involved in hypoxia|proteasom|stress|exhaustion
filtered_fgseaRes <- fgseaRes[grepl("HYPOXIA|PROTEASOM|STRESS|EXHAUSTION", fgseaRes$pathway), ]
filtered_fgseaRes$pathway <- fgseaRes$pathway[grepl("HYPOXIA|PROTEASOM|STRESS|EXHAUSTION", fgseaRes$pathway)]
filtered_fgseaRes[order(filtered_fgseaRes$pval), ]

```

Gene signatures from GSEA pathways
```{r}

m_df<- msigdbr(species = "Homo sapiens", category = "C2")
fgsea_sets.2 <- m_df %>% split(x = .$gene_symbol, f = .$gs_name)
m_df<- msigdbr(species = "Homo sapiens", category = "C5")
fgsea_sets.5 <- m_df %>% split(x = .$gene_symbol, f = .$gs_name)
m_df<- msigdbr(species = "Homo sapiens", category = "C7")
fgsea_sets.7 <- m_df %>% split(x = .$gene_symbol, f = .$gs_name)

```

Calculation of UCell signature scores (CD8.TerminallyExhausted vs. CD8.TEMRA)
```{r}

signatures.fgsea_set <- list(BIOCARTA_PROTEASOME_PATHWAY = fgsea_sets.2$BIOCARTA_PROTEASOME_PATHWAY,
                             KEGG_PROTEASOME = fgsea_sets.2$KEGG_PROTEASOME,
                             REACTOME_CELLULAR_RESPONSE_TO_HYPOXIA = fgsea_sets.2$REACTOME_CELLULAR_RESPONSE_TO_HYPOXIA,
                             REACTOME_DETOXIFICATION_OF_REACTIVE_OXYGEN_SPECIES = fgsea_sets.2$REACTOME_DETOXIFICATION_OF_REACTIVE_OXYGEN_SPECIES,
                             GOCC_PROTEASOME_COMPLEX = fgsea_sets.5$GOCC_PROTEASOME_COMPLEX,
                             WP_PROTEASOME_DEGRADATION = fgsea_sets.2$WP_PROTEASOME_DEGRADATION,
                             REACTOME_ANTIGEN_PROCESSING_UBIQUITINATION_PROTEASOME_DEGRADATION = fgsea_sets.2$REACTOME_ANTIGEN_PROCESSING_UBIQUITINATION_PROTEASOME_DEGRADATION,
                             GOBP_INTRINSIC_APOPTOTIC_SIGNALING_PATHWAY_IN_RESPONSE_TO_OXIDATIVE_STRESS = fgsea_sets.5$GOBP_INTRINSIC_APOPTOTIC_SIGNALING_PATHWAY_IN_RESPONSE_TO_OXIDATIVE_STRESS,
                             GOBP_REGULATION_OF_OXIDATIVE_STRESS_INDUCED_INTRINSIC_APOPTOTIC_SIGNALING_PATHWAY = fgsea_sets.5$GOBP_REGULATION_OF_OXIDATIVE_STRESS_INDUCED_INTRINSIC_APOPTOTIC_SIGNALING_PATHWAY, 
                             GOBP_PROTEASOMAL_PROTEIN_CATABOLIC_PROCESS = fgsea_sets.5$GOBP_PROTEASOMAL_PROTEIN_CATABOLIC_PROCESS,
                             GOCC_PROTEASOME_ACCESSORY_COMPLEX = fgsea_sets.5$GOCC_PROTEASOME_ACCESSORY_COMPLEX
                            )

DefaultAssay(projected.merged.comparisson) <- "RNA"
data_seurat <- AddModuleScore_UCell(projected.merged.comparisson, features = signatures.fgsea_set)
signature.names.gsea <- paste0(names(signatures.fgsea_set), "_UCell")

plotted <- c("iTEX_UCell",
             "Chu_Exhaustion_UCell",
             "Chu_Anergy_UCell",
             "Chu_Glycolysis_UCell",
             "Chu_Stress_response_UCell",
             "Chu_Oxidative_phosphorylation_UCell", 
             "GOCC_PROTEASOME_COMPLEX_UCell",
             "KEGG_PROTEASOME_UCell",
             "REACTOME_CELLULAR_RESPONSE_TO_HYPOXIA_UCell",
             "WP_PROTEASOME_DEGRADATION_UCell",
             "GOBP_REGULATION_OF_OXIDATIVE_STRESS_INDUCED_INTRINSIC_APOPTOTIC_SIGNALING_PATHWAY_UCell",
             "GOBP_INTRINSIC_APOPTOTIC_SIGNALING_PATHWAY_IN_RESPONSE_TO_OXIDATIVE_STRESS_UCell",
             "REACTOME_ANTIGEN_PROCESSING_UBIQUITINATION_PROTEASOME_DEGRADATION_UCell",
             "BIOCARTA_PROTEASOME_PATHWAY_UCell",
             "GOCC_PROTEASOME_ACCESSORY_COMPLEX_UCell",
             "GOBP_PROTEASOMAL_PROTEIN_CATABOLIC_PROCESS_UCell",
             "REACTOME_DETOXIFICATION_OF_REACTIVE_OXYGEN_SPECIES_UCell")

```

Stacked VlnPlot
Funtion adapted from: https://divingintogeneticsandgenomics.rbind.io/post/stacked-violin-plot-for-visualizing-single-cell-data-in-seurat/
```{r}

median.stat <- function(x){
    out <- quantile(x, probs = c(0.5))
    names(out) <- c("ymed")
    return(out) 
}

modify_vlnplot <- function(obj, 
                          feature, 
                          pt.size = 0, 
                          plot.margin = unit(c(-0.75, 0, -0.75, 0), "cm"),
                          ...) {
  
  median_value <- median(obj@assays$RNA_Seq$counts[, feature])
  
  p <- VlnPlot(obj, group.by = "functional.cluster.2", features = feature, pt.size = pt.size, ... )  + 
    xlab("") + ylab(feature) + ggtitle("") + 
    theme(legend.position = "none", 
          axis.text.x = element_blank(), 
          axis.ticks.x = element_blank(), 
          axis.title.y = element_text(size = rel(1), angle = 0), 
          axis.text.y = element_text(size = rel(1)),
          plot.margin = plot.margin,
          aspect.ratio = 0.33)  +
    coord_flip() +
    stat_summary(fun = median.stat, geom='point', size = 10, colour = "black") 
    
  return(p)
}

extract_max <- function(p){
  ymax <- max(ggplot_build(p)$layout$panel_scales_y[[1]]$range$range)
  return(ceiling(ymax))
}

StackedVlnPlot <- function(obj, features,
                          pt.size = 0, 
                          plot.margin = unit(c(-0.75, 0, -0.75, 0), "cm"),
                          ...) {
  idents_to_plot <- unique(obj$`functional.cluster.2`)
  plot_list <- purrr::map(features, function(x) modify_vlnplot(obj = obj, feature = x, ...))
  plot_list[[length(plot_list)]] <- plot_list[[length(plot_list)]] +
    theme(axis.text.x = element_text(), axis.ticks.x = element_line())
  p <- patchwork::wrap_plots(plotlist = plot_list, ncol = 1, byrow = FALSE)
  return(p)
}

pll <- StackedVlnPlot(obj = data_seurat, features = plotted)
ggsave(plot = pll, "figs/fig1g.violin.plots.pdf", height = 49, width = 49)

```

AUC calculation
```{r}

selFeatures <- plotted

w <- wilcoxauc(t(data_seurat@meta.data[,selFeatures]),y=data_seurat$functional.cluster)
ww <- w %>% filter(group == "CD8.TEX") %>% arrange(desc(auc)) %>% select(feature, logFC, auc, padj) 
write.table(ww, "figs/fig1g.auc.tsv")
gll <- ggplot(ww, aes(x = reorder(feature, auc), y = auc)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    axis.title.x = element_blank()
  ) +
  ggtitle("Prediction of T cell subtypes") +
  coord_flip(ylim = c(0.5, 1)) +
  theme(aspect.ratio = 1.5) 
ggsave(plot = gll, "figs/fig1g.auc.pdf", width = 297/12.7, height = 210/12.7)

```

### Supplementary Fig. S1a

Umap plots by study
```{r}

DimPlot(projected.merged.all, reduction = "umap", pt.size = 0.1, cols=my.colors, group.by = "dataset", split.by = "dataset", ncol = 11) + theme(aspect.ratio = 1) +
  NoLegend()

ggsave("figs/Supp.fig1a.pdf", width=20, height=20)

```

Pie chart
```{r}

table <- table(projected.merged.all$dataset)
labels <- rownames(table)
number <- as.vector(table)

pdf("figs/Supp.fig1a.pie.pdf")
pie(x = number, labels = labels, main="Contribution by study", col = my.colors, clockwise = T)
dev.off()

```

### Supplementary Fig. S1b

Umap plots by cancer type
```{r}

DimPlot(projected.merged.all, reduction = "umap", pt.size = 0.25, cols=my.colors, group.by = "cancerType", split.by = "cancerType", ncol = 11) + theme(aspect.ratio = 1) + NoLegend()
  
ggsave("figs/Supp.fig1b.pdf", width=20, height=20)

```

Pie chart by type of cancer
```{r}

table <- table(projected.merged.all$cancerType)
labels <- rownames(table)
number <- as.vector(table)

pdf("figs/Supp.fig1b.pie.pdf")
pie(x = number, labels = labels, main="Contribution by cancerType", col = my.colors, clockwise = T)
dev.off()

```

### Supplementary Fig. S2a

Expression of Chu et al. 2023 T cell signatures
```{r}

DotPlot(projected.merged.all.order, group.by = "functional.cluster.2",
        features = c("Chu_NaÃ¯ve_UCell",
                     "Chu_Exhaustion_UCell",
                     "Chu_TCR_Signaling_UCell",
                     "Chu_Cytotoxicity_UCell",
                     "Chu_Anergy_UCell",
                     "Chu_NFKB_Signaling_UCell",
                     "Chu_Stress_response_UCell",
                     "Chu_MAPK_Signaling_UCell",
                     "Chu_Oxidative_phosphorylation_UCell",
                     "Chu_Glycolysis_UCell",
                     "Chu_Fatty_acid_metabolism_UCell"),
        cols="RdBu", scale=T, col.max=1.5) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  theme(aspect.ratio = 0.5)

ggsave("figs/Supp.fig2a.dotplot.pdf", width=9, height=9)

```

### Supplementary Fig. S2b

Correlation between signatures
```{r}

DefaultAssay(projected.merged.all) <- "RNA"
data_correlation <- AddModuleScore_UCell(projected.merged.all, features = signatures.fgsea_set)
signature.names.cor <- paste0(names(signatures.fgsea_set), "_UCell")

cor.plot <- data_seurat@meta.data[, plotted]

# Calculate the spearman correlation matrix
cor_matrix <- cor(cor.plot, method = "spearman") 
pll <- ggcorrplot(cor_matrix, type = "upper", lab = TRUE,sig.level = T, hc.order = TRUE) + theme(aspect.ratio = 1)

ggsave("figs/Supp.fig2b.fgsea.correlations.all.pdf", width = 297/12.7, height = 210/12.7)

```

# Save

```{r}

saveRDS(projected.merged.all, "seurat/Zheng.seurat.projected.ds.rds")

```
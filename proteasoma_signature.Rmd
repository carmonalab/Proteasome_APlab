---
title: Analyse proteasomal gene expression in Tex and T_EM
author: "M. Andreatta <massimo.andreatta at unil.ch> and S. Carmona <santiago.carmona at unil.ch>"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
#output: html_notebook
---

```{r}
library(ggplot2)
library(Seurat)
library(UCell)
library(scGate)
library(msigdbr)
library(presto)
```

MSIGDB hallmark signatures
```{r}
m_df<- msigdbr(species = "Homo sapiens", category = "H")
fgsea_sets <- m_df %>% split(x = .$gene_symbol, f = .$gs_name)
fgsea_sets$HALLMARK_HYPOXIA
fgsea_sets$HALLMARK_REACTIVE_OXYGEN_SPECIES_PATHWAY
```


```{r}
signatures <- list(UPS = c("PSMB2", "PSMC3", "RBX1"),
                   PROTEASOME = c("PSMA1", "PSMA2", "PSMA3", "PSMA4", "PSMA5", "PSMA6", "PSMA7", "PSMB1", "PSMB2", "PSMB3", "PSMB4", "PSMB5", "PSMB6", "PSMB7", "PSMC1", "PSMC2", "PSMC3", "PSMC4", "PSMC5", "PSMC6", "PSMD1", "PSMD2", "PSMD3", "PSMD4", "PSMD6", "PSMD7", "PSMD8", "PSMD11", "PSMD12", "PSMD13", "PSMD14"),
                   HYPOXIC_EXHAUSTION  = c("PSMC3", "PSMB2", "RBPJ", "RBX1", "PKM", "PGK1", "PSMB8", "ENO1", "LDHA", "CHCHD2"),
                   HYPOXIC_EXHAUSTION_UNIQ = c("RBX1","PKM","PGK1","PSMB8","ENO1","LDHA","CHCHD2"),
                   CHAPERONES = c("PSMG1", "PSMG2", "PSMG3", "PSMG4", "POMP", "PSMD9", "PSMD5", "PAAF1"),
                   TF = c("NRF1", "NFE2L1"),
                   EXHAUSTION = c("HAVCR2","PDCD1","LAG3","TIGIT","TOX","ENTPD1","CTLA4"),
                   
                   T_EX = c("HAVCR2","PDCD1","LAG3","TOX","TOX2","ENTPD1","CTLA4","CXCL13","GZMB"),
                   T_EM = c("IL7R","TCF7","GZMK","GZMM","ANXA1","CCL5"),
                   cellCycle.G1S = scGate::genes.blacklist.default$Hs$cellCycle.G1S,
                   cellCycle.G2M = scGate::genes.blacklist.default$Hs$cellCycle.G2M,
                   HALLMARK_HYPOXIA=fgsea_sets$HALLMARK_HYPOXIA,
                   HALLMARK_ROS = fgsea_sets$HALLMARK_REACTIVE_OXYGEN_SPECIES_PATHWAY
                  )


```

Check signature sets overlap
```{r}
lapply(signatures,function(x){intersect(x,signatures$EXHAUSTION)})
```

```{r}
lapply(signatures,function(x){intersect(x,signatures$PROTEASOME)})
```

OBS: There are no unexpected gene overlaps.


Generated from "Generate_heatmap.Rmd"
```{r}

data_seurat <- readRDS("aux/Zheng.seurat.gated.annotated.Tex_Tem.merged.rds")

```

```{r}
data_seurat <- UCell::AddModuleScore_UCell(data_seurat,signatures,ncores = 4)
myFeaturesUcell <- paste0(names(signatures),"_UCell")
```

```{r, fig.height=10, fig.width=10}
Idents(data_seurat) <- "functional.cluster"
cols.functional.cluster <- c("#53B400","#edbe2a")
VlnPlot(data_seurat,features = myFeaturesUcell, pt.size = 0, stack = T, 
        flip = T, cols = cols.functional.cluster, fill.by	="ident") + NoLegend()
ggsave("plots/signatures.vln.by.subtype.pdf", height=14, width=6)

```

```{r fig.height=6}
pp <- list()
pp[[length(pp)+1]] <- FeatureScatter(data_seurat,"EXHAUSTION_UCell","PROTEASOME_UCell", smooth = F, raster = T,cols = cols.functional.cluster, pt.size = 3) + theme(aspect.ratio=1)
pp[[length(pp)+1]] <- FeatureScatter(data_seurat,"EXHAUSTION_UCell","HALLMARK_HYPOXIA_UCell", smooth = F, raster = T,cols = cols.functional.cluster, pt.size = 3) + theme(aspect.ratio=1)
pp[[length(pp)+1]] <- FeatureScatter(data_seurat,"EXHAUSTION_UCell","CHAPERONES_UCell", smooth = F, raster = T,cols = cols.functional.cluster, pt.size = 3) + theme(aspect.ratio=1)
pp[[length(pp)+1]] <- FeatureScatter(data_seurat,"EXHAUSTION_UCell","HALLMARK_ROS_UCell", smooth = F, raster = T,cols = cols.functional.cluster, pt.size = 3) + theme(aspect.ratio=1)
pp[[length(pp)+1]] <- FeatureScatter(data_seurat,"PROTEASOME_UCell","HALLMARK_HYPOXIA_UCell", smooth = F, raster = T,cols = cols.functional.cluster, pt.size = 3) + theme(aspect.ratio=1)
pp[[length(pp)+1]] <- FeatureScatter(data_seurat,"PROTEASOME_UCell","HALLMARK_ROS_UCell", smooth = F, raster = T,cols = cols.functional.cluster, pt.size = 3) + theme(aspect.ratio=1)
wrap_plots(pp)
ggsave("plots/signatures.cor.png", height=10, width=20)
```

OBS: PROTEASOME_UCell is correlated with EXHAUSTION (cor=0.14) and with ROS (0.27)


```{r}
Idents(data_seurat) <- "cancerType"
FeatureScatter(data_seurat,"EXHAUSTION_UCell","PROTEASOME_UCell", smooth = T, raster = T) + theme(aspect.ratio=1)
Idents(data_seurat) <- "functional.cluster"
```
Scatter by cancer type
```{r}

Idents(data_seurat) <- "cancerType"
data_seurat.list <- SplitObject(data_seurat)
Idents(data_seurat) <- "functional.cluster"

pp.cancerTypes.scatter <- list()
pp.cancerTypes.vln <- list()

for( i in names(data_seurat.list)){
  pp.cancerTypes.scatter[[i]] <- FeatureScatter(data_seurat.list[[i]],"EXHAUSTION_UCell","PROTEASOME_UCell", smooth = F, raster = T, group.by = "functional.cluster", cols = cols.functional.cluster, pt.size = 3) + theme(aspect.ratio=1) + labs(subtitle = i)
  pp.cancerTypes.vln[[i]] <- VlnPlot(data_seurat.list[[i]],features = c("EXHAUSTION_UCell","PROTEASOME_UCell"), group.by = "functional.cluster",pt.size = 0, fill.by = "ident", cols=cols.functional.cluster, stack = T, flip = T) + theme(aspect.ratio=1) + labs(title = i) +
  theme(legend.position="none")
}

wp <- wrap_plots(pp.cancerTypes.scatter)
ggsave("plots/signatures.cor.byCancerType.png", height=30, width=30)

wp2 <- wrap_plots(pp.cancerTypes.vln)
ggsave("plots/signatures.vln.byCancerType.png", height=30, width=30)

rm(data_seurat.list)
```

OBS: PROTEASOME_UCell is generally positively correlated with EXHAUSTION across cancer types
EXHAUSTION and PROTEASOME_UCell always higher in Tex vs Tem

Evaluate AUC on classification of Tex vs Tem
```{r}
#combined signature for higher discrimination
data_seurat$T_EX_sub_T_EM_UCell <- data_seurat$T_EX_UCell - data_seurat$T_EM_UCell

selFeatures <- c("EXHAUSTION_UCell","PROTEASOME_UCell","HALLMARK_ROS_UCell","HALLMARK_HYPOXIA_UCell")
#selFeatures <- c(myFeaturesUcell,"T_EX_sub_T_EM_UCell")
w <- wilcoxauc(t(data_seurat@meta.data[,selFeatures]),y=data_seurat$functional.cluster)
ww <- w %>% filter(group == "CD8_Tex") %>% arrange(desc(auc)) %>% select(feature, logFC, auc, padj) 
ww
```
PROTEASOME_UCell AUC 0.68


```{r}
ggplot(ww, aes(x=reorder(feature,-auc), y=auc)) + geom_bar(stat="identity") + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), 
        axis.title.x=element_blank()) +
  coord_cartesian(ylim=c(0.5, 0.75)) +
  ggtitle("Prediction of T cell subtypes")

ggsave("plots/auc.signatures.subtype.png", height=4, width=4)
```

As a control, generate alternative cell classifications

Based on canonical exhaustion features
```{r}
data_seurat@meta.data$EXHAUSTION_UCell_HIGH <- ifelse(data_seurat@meta.data$EXHAUSTION_UCell>0.15,
                                                      "EXHAUSTION_UCell_HIGH",
                                                      "EXHAUSTION_UCell_LOW")

table(data_seurat@meta.data$EXHAUSTION_UCell_HIGH)
```

```{r}
selFeatures <- c("EXHAUSTION_UCell","PROTEASOME_UCell","HALLMARK_ROS_UCell","HALLMARK_HYPOXIA_UCell")
w <- wilcoxauc(t(data_seurat@meta.data[,selFeatures]), y=data_seurat$EXHAUSTION_UCell_HIGH)
ww <- w %>% filter(group == "EXHAUSTION_UCell_HIGH") %>% arrange(desc(auc)) %>% select(feature, logFC, auc, padj) 
ww

ggplot(ww,aes(x=reorder(feature,-auc),y=auc)) + geom_bar(stat="identity") + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), 
        axis.title.x=element_blank()) +
  coord_cartesian(ylim=c(0.45, 1)) +
  ggtitle("Prediction of T cell subtypes")

ggsave("plots/auc.signatures.subtype.by.Exh.png", height=4, width=4)
```
PROTEASOME_UCell AUC 0.58


Based on canonical exhaustion features
```{r}
hist(data_seurat@meta.data$T_EX_sub_T_EM_UCell)

data_seurat@meta.data$T_EX_sub_T_EM_UCell_HIGH <-
  ifelse(data_seurat@meta.data$T_EX_sub_T_EM_UCell>0,"T_EX_sub_T_EM_UCell_HIGH","T_EX_sub_T_EM_UCell_LOW")

table(data_seurat@meta.data$T_EX_sub_T_EM_UCell_HIGH,data_seurat@meta.data$functional.cluster)
```

```{r}
selFeatures <- c("T_EX_sub_T_EM_UCell","EXHAUSTION_UCell","PROTEASOME_UCell","HALLMARK_ROS_UCell","HALLMARK_HYPOXIA_UCell")
w <- wilcoxauc(t(data_seurat@meta.data[,selFeatures]),y=data_seurat$T_EX_sub_T_EM_UCell_HIGH)
ww <- w %>% filter(group == "T_EX_sub_T_EM_UCell_HIGH") %>% arrange(desc(auc)) %>% select(feature, logFC, auc, padj) 
ww
ggplot(ww,aes(x=feature,y=auc)) + geom_bar(stat="identity") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + ylim(c(0,1))
```
PROTEASOME_UCell AUC 0.58


Based on Zheng's annotation
```{r}
data_seurat$meta.cluster.coarse.TexTem <- NA
data_seurat$meta.cluster.coarse.TexTem[data_seurat$meta.cluster.coarse %in% c("CD8.c09.Tex.CXCL13","CD8.c05.Tem.GZMK")] <- data_seurat$meta.cluster.coarse[data_seurat$meta.cluster.coarse %in% c("CD8.c09.Tex.CXCL13","CD8.c05.Tem.GZMK")]
table(data_seurat@meta.data$meta.cluster.coarse.TexTem,data_seurat@meta.data$functional.cluster,useNA = "always")

```


```{r}
selFeatures <- c("EXHAUSTION_UCell","PROTEASOME_UCell","HALLMARK_ROS_UCell","HALLMARK_HYPOXIA_UCell")
w <- wilcoxauc(t(data_seurat@meta.data[,selFeatures]),y=data_seurat$meta.cluster.coarse.TexTem)
ww <- w %>% filter(group == "CD8.c09.Tex.CXCL13") %>% arrange(desc(auc)) %>% select(feature, logFC, auc, padj) 
ww


ggplot(ww,aes(x=reorder(feature,-auc),y=auc)) + geom_bar(stat="identity") + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), 
        axis.title.x=element_blank()) +
  coord_cartesian(ylim=c(0.5, 0.9)) +
  ggtitle("Prediction of T cell subtypes")

ggsave("plots/auc.signatures.subtype.zheng.ann.png", height=4, width=4)
```
PROTEASOME_UCell AUC 0.58


PROTEASOME_UCell is generally predictive of Tex.


Can we generate a signature of PROTEASOME that is specific to Exhaustion?
Find highly correlated PROTEASOME genes in half of the studies, and test in the other half:

```{r}
set.seed(123)
ds <- unique(data_seurat$dataset)
ds.train <- sample(ds,length(ds)/2)
print("train")
ds.train
ds.test <- setdiff(ds,ds.train)
print("test")
ds.test
```
```{r}
Idents(data_seurat) <- "dataset"
data_seurat.train <- subset(data_seurat, idents = ds.train)
table(data_seurat.train$dataset)
data_seurat.test <- subset(data_seurat, idents = ds.test)
table(data_seurat.test$dataset)
```
Find  PROTEASOMAL sig genes correlation with exhaustion

```{r}
cors <- apply(data_seurat.train@assays$RNA@data[signatures$PROTEASOME,],1,function(x){cor(data_seurat.train$EXHAUSTION_UCell,x)})
sort(cors)
```

```{r}
barplot(sort(cors))
hist(cors,nclass = 20)
FeatureScatter(data_seurat.test,feature1 = "EXHAUSTION_UCell", feature2 = "PSMB2", smooth = F, raster = T, group.by = "functional.cluster", cols = cols.functional.cluster, pt.size = 3) + theme(aspect.ratio=1) 
FeatureScatter(data_seurat.test,feature1 = "EXHAUSTION_UCell", feature2 = "PSMB4", smooth = F, raster = T, group.by = "functional.cluster", cols = cols.functional.cluster, pt.size = 3) + theme(aspect.ratio=1) 
```
Basically all PROTEASOME genes are positively correlated with exhaustion; not big gain is expected by selecting

```{r}
signatures$PROTEASOME_EXHAUSTED <- names(cors[cors>0.1])
```

Evaluate correlation in test dataset
```{r}
cors.test <- apply(data_seurat.test@assays$RNA@data[signatures$PROTEASOME,],1,function(x){cor(data_seurat.test$EXHAUSTION_UCell,x)})
plot(cors.test,cors,col = (names(cors) %in% signatures$PROTEASOME_EXHAUSTED)+1)
```
Correlations are consistent between training and test datasets

Add new gene signature
```{r}
data_seurat <- UCell::AddModuleScore_UCell(data_seurat,list(PROTEASOME_EXHAUSTED=signatures$PROTEASOME_EXHAUSTED),ncores = 4)
data_seurat$train.test <- "train"
data_seurat$train.test[data_seurat$dataset %in% ds.test] <- "test"
table(data_seurat$train.test,data_seurat$dataset)
```


```{r}
FeatureScatter(data_seurat,"PROTEASOME_EXHAUSTED_UCell","PROTEASOME_UCell", smooth = F, raster = T, group.by = "functional.cluster", cols = cols.functional.cluster, pt.size = 3) + theme(aspect.ratio=1) 
FeatureScatter(data_seurat,"EXHAUSTION_UCell","PROTEASOME_EXHAUSTED_UCell", smooth = F, raster = T, group.by = "functional.cluster", cols = cols.functional.cluster, pt.size = 3) + theme(aspect.ratio=1) 
FeatureScatter(data_seurat,"EXHAUSTION_UCell","PROTEASOME_UCell", smooth = F, raster = T, group.by = "functional.cluster", cols = cols.functional.cluster, pt.size = 3) + theme(aspect.ratio=1) 
```

```{r}
VlnPlot(data_seurat,features = c("EXHAUSTION_UCell","PROTEASOME_UCell","PROTEASOME_EXHAUSTED_UCell"), group.by = "functional.cluster",pt.size = 0, fill.by = "ident", cols=cols.functional.cluster, stack = T, flip = T) + theme(aspect.ratio=1)  +  theme(legend.position="none")
```
Evaluate AUCs, how is this new score separating subtypes?
```{r}

selFeatures <- c("EXHAUSTION_UCell","PROTEASOME_UCell","HALLMARK_ROS_UCell","HALLMARK_HYPOXIA_UCell","PROTEASOME_EXHAUSTED_UCell")
w <- wilcoxauc(t(data_seurat@meta.data[,selFeatures]),y=data_seurat$functional.cluster)
ww <- w %>% filter(group == "CD8_Tex") %>% arrange(desc(auc)) %>% select(feature, logFC, auc, padj) 
ww
```
Based on canonical exhaustion
```{r}
w <- wilcoxauc(t(data_seurat@meta.data[,selFeatures]),y=data_seurat$EXHAUSTION_UCell_HIGH)
ww <- w %>% filter(group == "EXHAUSTION_UCell_HIGH") %>% arrange(desc(auc)) %>% select(feature, logFC, auc, padj) 
ww
```
Indeed, signal is slightly reduced by reducing set of PROTEASOME genes; we can keep them all; all choose to simplfy the signature with minimal loss of predicition.
